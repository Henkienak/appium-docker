'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _nodeSimctl = require('node-simctl');

var _iosAppUtils = require('ios-app-utils');

var _webdriveragent = require('./webdriveragent');

var _webdriveragent2 = _interopRequireDefault(_webdriveragent);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _simulatorManagement = require('./simulator-management');

var _appiumIosSimulator = require('appium-ios-simulator');

var _asyncbox = require('asyncbox');

var _appiumIosDriver = require('appium-ios-driver');

var _desiredCaps = require('./desired-caps');

var _desiredCaps2 = _interopRequireDefault(_desiredCaps);

var _commandsIndex = require('./commands/index');

var _commandsIndex2 = _interopRequireDefault(_commandsIndex);

var _utils = require('./utils');

var _realDeviceManagement = require('./real-device-management');

var _iosDeploy = require('./ios-deploy');

var _iosDeploy2 = _interopRequireDefault(_iosDeploy);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _packageJson = require('../../package.json');

// eslint-disable-line import/no-unresolved

var SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';

var NO_PROXY_NATIVE_LIST = [['GET', /context/], ['POST', /context/], ['GET', /window/], ['POST', /window/], ['DELETE', /window/], ['POST', /execute/], ['POST', /element$/], ['POST', /elements$/], ['POST', /timeouts/], ['GET', /alert_text/], ['POST', /alert_text/], ['POST', /accept_alert/], ['POST', /dismiss_alert/], ['GET', /source/], ['POST', /appium/], ['GET', /appium/], ['POST', /touch/], ['POST', /click/], ['GET', /log/], ['POST', /log/], ['POST', /moveto/], ['POST', /receive_async_response/], // always, in case context switches while waiting
['GET', /location/], ['GET', /size/], ['POST', /value/]];
var NO_PROXY_WEB_LIST = [['GET', /title/], ['GET', /url/], ['POST', /url/], ['POST', /element/], ['POST', /back/], ['POST', /forward/], ['GET', /attribute/], ['GET', /text/], ['POST', /clear/], ['GET', /element/], ['POST', /click/], ['POST', /refresh/], ['GET', /cookie/], ['POST', /cookie/], ['DELETE', /cookie/], ['POST', /frame/]].concat(NO_PROXY_NATIVE_LIST);

var XCUITestDriver = (function (_BaseDriver) {
  _inherits(XCUITestDriver, _BaseDriver);

  function XCUITestDriver() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
    var shouldValidateCaps = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

    _classCallCheck(this, XCUITestDriver);

    _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'constructor', this).call(this, opts, shouldValidateCaps);

    _logger2['default'].debug('XCUITestDriver version: ' + _packageJson.version);

    this.desiredCapConstraints = _desiredCaps2['default'];

    this.locatorStrategies = ['xpath', 'id', 'name', 'class name', '-ios predicate string', 'accessibility id'];
    this.webLocatorStrategies = ['link text', 'css selector', 'tag name', 'link text', 'partial link text'];

    this.resetIos();
  }

  _createClass(XCUITestDriver, [{
    key: 'resetIos',
    value: function resetIos() {
      this.opts = this.opts || {};
      this.wda = null;
      this.opts.device = null;
      this.jwpProxyActive = false;
      this.proxyReqRes = null;
      this.jwpProxyAvoid = [];
      this.safari = false;

      // some things that commands imported from appium-ios-driver need
      this.curWebFrames = [];
      this.webElementIds = [];
      this._currentUrl = null;
      this.curContext = null;
      this.xcodeVersion = null;
      this.iosSdkVersion = null;
      this.contexts = [];
      this.implicitWaitMs = 0;
      this.asynclibWaitMs = 0;
      this.pageLoadMs = 6000;
    }
  }, {
    key: 'getStatus',
    value: function getStatus() {
      var wdaStatus;
      return _regeneratorRuntime.async(function getStatus$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.proxyCommand('/status', 'GET'));

          case 2:
            wdaStatus = context$2$0.sent;
            return context$2$0.abrupt('return', { wda: wdaStatus });

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createSession',
    value: function createSession(caps) {
      var _ref, _ref2, sessionId;

      return _regeneratorRuntime.async(function createSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.lifecycleData = {}; // this is used for keeping track of the state we start so when we delete the session we can put things back
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(XCUITestDriver.prototype), 'createSession', this).call(this, caps));

          case 4:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 1);
            sessionId = _ref2[0];

            this.opts.sessionId = sessionId;

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.start());

          case 10:

            // merge server capabilities + desired capabilities
            caps = _Object$assign({}, _appiumIosDriver.defaultServerCaps, caps);
            return context$2$0.abrupt('return', [sessionId, caps]);

          case 14:
            context$2$0.prev = 14;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].error(context$2$0.t0);
            context$2$0.next = 19;
            return _regeneratorRuntime.awrap(this.deleteSession());

          case 19:
            throw context$2$0.t0;

          case 20:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 14]]);
    }
  }, {
    key: 'start',
    value: function start() {
      var _ref3, device, udid, realDevice;

      return _regeneratorRuntime.async(function start$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.opts.noReset = !!this.opts.noReset;
            this.opts.fullReset = !!this.opts.fullReset;

            if (this.xcodeVersion) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _utils.getAndCheckXcodeVersion)());

          case 5:
            this.xcodeVersion = context$2$0.sent;

            _logger2['default'].debug('Xcode version set to \'' + this.xcodeVersion.versionString + '\'');

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _utils.getAndCheckIosSdkVersion)());

          case 9:
            this.iosSdkVersion = context$2$0.sent;

            _logger2['default'].debug('iOS SDK Version set to \'' + this.iosSdkVersion + '\'');

            if (!(this.opts.platformVersion && parseFloat(this.opts.platformVersion) < 9.3)) {
              context$2$0.next = 13;
              break;
            }

            throw Error('Platform version must be 9.3 or above. \'' + this.opts.platformVersion + '\' is not supported.');

          case 13:
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.determineDevice());

          case 15:
            _ref3 = context$2$0.sent;
            device = _ref3.device;
            udid = _ref3.udid;
            realDevice = _ref3.realDevice;

            _logger2['default'].info('Determining device to run tests on: udid: \'' + udid + '\', real device: ' + realDevice);
            this.opts.device = device;
            this.opts.udid = udid;
            this.opts.realDevice = realDevice;

            // at this point if there is no platformVersion, get it from the device

            if (this.opts.platformVersion) {
              context$2$0.next = 31;
              break;
            }

            if (!(this.opts.device && _lodash2['default'].isFunction(this.opts.device.getPlatformVersion))) {
              context$2$0.next = 31;
              break;
            }

            context$2$0.next = 27;
            return _regeneratorRuntime.awrap(this.opts.device.getPlatformVersion());

          case 27:
            this.opts.platformVersion = context$2$0.sent;

            _logger2['default'].info('No platformVersion specified. Using device version: \'' + this.opts.platformVersion + '\'');
            context$2$0.next = 31;
            break;

          case 31:
            if (!this.opts.browserName) {
              context$2$0.next = 41;
              break;
            }

            _logger2['default'].info('Safari test requested');
            this.safari = true;
            this.opts.app = undefined;
            this.opts.processArguments = this.opts.processArguments || {};
            this.opts.bundleId = SAFARI_BUNDLE_ID;
            this._currentUrl = this.opts.safariInitialUrl || (this.isRealDevice() ? 'http://appium.io' : 'http://' + this.opts.address + ':' + this.opts.port + '/welcome');
            this.opts.processArguments.args = ['-u', this._currentUrl];
            context$2$0.next = 43;
            break;

          case 41:
            context$2$0.next = 43;
            return _regeneratorRuntime.awrap(this.configureApp());

          case 43:
            if (!this.opts.app) {
              context$2$0.next = 46;
              break;
            }

            context$2$0.next = 46;
            return _regeneratorRuntime.awrap(this.checkAppPresent());

          case 46:
            if (this.opts.bundleId) {
              context$2$0.next = 50;
              break;
            }

            context$2$0.next = 49;
            return _regeneratorRuntime.awrap(this.extractBundleId(this.opts.app));

          case 49:
            this.opts.bundleId = context$2$0.sent;

          case 50:

            // handle logging
            this.logs = {};
            context$2$0.next = 53;
            return _regeneratorRuntime.awrap(this.startLogCapture());

          case 53:

            _logger2['default'].info('Setting up ' + (this.isRealDevice() ? 'real device' : 'simulator'));

            if (this.isRealDevice()) {
              context$2$0.next = 62;
              break;
            }

            context$2$0.next = 57;
            return _regeneratorRuntime.awrap(_appiumIosDriver.settings.setLocale(this.opts.device, this.opts, {}, this.isSafari()));

          case 57:
            this.localeConfig = context$2$0.sent;
            context$2$0.next = 60;
            return _regeneratorRuntime.awrap(_appiumIosDriver.settings.setPreferences(this.opts.device, this.opts, this.isSafari()));

          case 60:
            context$2$0.next = 62;
            return _regeneratorRuntime.awrap(this.startSim());

          case 62:
            context$2$0.next = 64;
            return _regeneratorRuntime.awrap(this.installApp());

          case 64:
            context$2$0.next = 66;
            return _regeneratorRuntime.awrap(this.startWda(this.opts.sessionId, realDevice));

          case 66:
            context$2$0.next = 68;
            return _regeneratorRuntime.awrap(this.setInitialOrientation(this.opts.orientation));

          case 68:
            if (!(this.isSafari() || this.opts.autoWebview)) {
              context$2$0.next = 72;
              break;
            }

            _logger2['default'].debug('Waiting for initial webview');
            context$2$0.next = 72;
            return _regeneratorRuntime.awrap(this.navToInitialWebview());

          case 72:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startWda',
    value: function startWda(sessionId, realDevice) {
      return _regeneratorRuntime.async(function startWda$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.wda = new _webdriveragent2['default'](this.opts);

            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.wda.launch(sessionId, realDevice));

          case 4:
            context$2$0.next = 15;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            if (!((context$2$0.t0.message || '').indexOf('xcodebuild failed with code 65') === -1)) {
              context$2$0.next = 10;
              break;
            }

            throw context$2$0.t0;

          case 10:
            // Xcode error code 65 means that the WDA app is still being installed
            // and xcodebuild can't do its business, so it is reasonable to retry
            _logger2['default'].debug('xcodebuild failure warrants retry. Retrying...');
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.wda.quit());

          case 13:
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.wda.launch(sessionId, realDevice));

          case 15:

            this.proxyReqRes = this.wda.proxyReqRes.bind(this.wda);
            this.jwpProxyActive = true;

            context$2$0.next = 19;
            return _regeneratorRuntime.awrap(this.startWdaSession(this.opts.bundleId, this.opts.processArguments));

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }

    // create an alias so we can actually unit test createSession by stubbing
    // this
  }, {
    key: 'extractBundleId',
    value: function extractBundleId(app) {
      return _regeneratorRuntime.async(function extractBundleId$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _iosAppUtils.extractBundleId)(app));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.stop());

          case 2:
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(XCUITestDriver.prototype), 'deleteSession', this).call(this));

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.jwpProxyActive = false;
            this.proxyReqRes = null;

            if (!(this.wda && this.wda.jwproxy)) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.proxyCommand('/session/' + this.sessionId, 'DELETE'));

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.wda.quit());

          case 7:
            if (!this.isWebContext()) {
              context$2$0.next = 11;
              break;
            }

            _logger2['default'].debug('In a web session. Removing remote debugger');
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.stopRemote());

          case 11:
            if (!this.isRealDevice()) {
              context$2$0.next = 16;
              break;
            }

            context$2$0.next = 14;
            return _regeneratorRuntime.awrap((0, _realDeviceManagement.runRealDeviceReset)(this.opts.device, this.opts));

          case 14:
            context$2$0.next = 18;
            break;

          case 16:
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.runSimulatorReset)(this.opts.device, this.opts));

          case 18:
            if (!(!this.opts.noReset && !!this.opts.device)) {
              context$2$0.next = 28;
              break;
            }

            _logger2['default'].debug('Resetting simulator');

            if (!this.lifecycleData.bootSim) {
              context$2$0.next = 24;
              break;
            }

            _logger2['default'].debug('Shutting down simulator');
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(this.opts.device.shutdown());

          case 24:
            if (!this.lifecycleData.createSim) {
              context$2$0.next = 28;
              break;
            }

            _logger2['default'].debug('Deleting simulator created for this run');
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(this.opts.device['delete']());

          case 28:

            if (!_lodash2['default'].isEmpty(this.logs)) {
              this.logs.syslog.stopCapture();
              this.logs = {};
            }

            this.resetIos();

          case 30:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'executeCommand',
    value: function executeCommand(cmd) {
      var _get2;

      for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        args[_key - 1] = arguments[_key];
      }

      return _regeneratorRuntime.async(function executeCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Executing command \'' + cmd + '\'');

            if (!(cmd === 'receiveAsyncResponse')) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.receiveAsyncResponse.apply(this, args));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((_get2 = _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'executeCommand', this)).call.apply(_get2, [this, cmd].concat(args)));

          case 7:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'checkAppPresent',
    value: function checkAppPresent() {
      return _regeneratorRuntime.async(function checkAppPresent$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug("Checking whether app is actually present");
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.opts.app));

          case 3:
            if (context$2$0.sent) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].errorAndThrow('Could not find app at ' + this.opts.app);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'configureApp',
    value: function configureApp() {
      var appIsPackageOrBundle;
      return _regeneratorRuntime.async(function configureApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            appIsPackageOrBundle = function appIsPackageOrBundle(app) {
              return (/^([a-zA-Z0-9\-_]+\.[a-zA-Z0-9\-_]+)+$/.test(app)
              );
            };

            if (!(!this.opts.bundleId && appIsPackageOrBundle(this.opts.app))) {
              context$2$0.next = 4;
              break;
            }

            this.opts.bundleId = this.opts.app;
            return context$2$0.abrupt('return');

          case 4:
            if (!(this.opts.bundleId && appIsPackageOrBundle(this.opts.bundleId) && (this.opts.app === '' || appIsPackageOrBundle(this.opts.app)))) {
              context$2$0.next = 7;
              break;
            }

            _logger2['default'].debug('App is an iOS bundle, will attempt to run as pre-existing');
            return context$2$0.abrupt('return');

          case 7:
            if (!(this.opts.app && this.opts.app.toLowerCase() === 'settings')) {
              context$2$0.next = 13;
              break;
            }

            this.opts.bundleId = 'com.apple.Preferences';
            this.opts.app = null;
            return context$2$0.abrupt('return');

          case 13:
            if (!(this.opts.app && this.opts.app.toLowerCase() === 'calendar')) {
              context$2$0.next = 17;
              break;
            }

            this.opts.bundleId = 'com.apple.mobilecal';
            this.opts.app = null;
            return context$2$0.abrupt('return');

          case 17:
            context$2$0.prev = 17;
            context$2$0.next = 20;
            return _regeneratorRuntime.awrap(this.helpers.configureApp(this.opts.app, '.app', this.opts.mountRoot, this.opts.windowsShareUserName, this.opts.windowsSharePassword));

          case 20:
            this.opts.app = context$2$0.sent;
            context$2$0.next = 27;
            break;

          case 23:
            context$2$0.prev = 23;
            context$2$0.t0 = context$2$0['catch'](17);

            _logger2['default'].error(context$2$0.t0);
            throw new Error('Bad app: ' + this.opts.app + '. App paths need to be absolute, or relative to the appium ' + 'server install dir, or a URL to compressed file, or a special app name.');

          case 27:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[17, 23]]);
    }
  }, {
    key: 'determineDevice',
    value: function determineDevice() {
      var _device, devices, _device2, device;

      return _regeneratorRuntime.async(function determineDevice$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // in the one case where we create a sim, we will set this state
            this.lifecycleData.createSim = false;

            // if we get generic names, translate them
            this.opts.deviceName = (function translateDeviceName() {
              var dn = arguments.length <= 0 || arguments[0] === undefined ? '' : arguments[0];

              var deviceName = dn;
              if (dn.toLowerCase() === 'iphone simulator') {
                deviceName = 'iPhone 6';
              } else if (dn.toLowerCase() === 'ipad simulator') {
                deviceName = 'iPad 2';
              }
              if (deviceName !== dn) {
                _logger2['default'].debug('Changing deviceName from \'' + dn + '\' to \'' + deviceName + '\'');
              }
              return deviceName;
            })(this.opts.deviceName);

            // check for a particular simulator
            context$2$0.t0 = this.opts.udid;

            if (!context$2$0.t0) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.simExists)(this.opts.udid));

          case 6:
            context$2$0.t0 = context$2$0.sent;

          case 7:
            if (!context$2$0.t0) {
              context$2$0.next = 12;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.getSimulator)(this.opts.udid));

          case 10:
            _device = context$2$0.sent;
            return context$2$0.abrupt('return', { device: _device, realDevice: false, udid: this.opts.udid });

          case 12:
            if (!this.opts.udid) {
              context$2$0.next = 29;
              break;
            }

            if (!(this.opts.udid.toLowerCase() === 'auto')) {
              context$2$0.next = 19;
              break;
            }

            context$2$0.next = 16;
            return _regeneratorRuntime.awrap((0, _utils.detectUdid)());

          case 16:
            this.opts.udid = context$2$0.sent;
            context$2$0.next = 25;
            break;

          case 19:
            context$2$0.next = 21;
            return _regeneratorRuntime.awrap((0, _realDeviceManagement.getConnectedDevices)());

          case 21:
            devices = context$2$0.sent;

            _logger2['default'].debug('Available devices: ' + devices.join(', '));

            if (!(devices.indexOf(this.opts.udid) === -1)) {
              context$2$0.next = 25;
              break;
            }

            throw new Error('Unknown device or simulator UDID: \'' + this.opts.udid + '\'');

          case 25:
            context$2$0.next = 27;
            return _regeneratorRuntime.awrap(this.getIDeviceObj());

          case 27:
            _device2 = context$2$0.sent;
            return context$2$0.abrupt('return', { device: _device2, realDevice: true, udid: this.opts.udid });

          case 29:
            context$2$0.next = 31;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.getExistingSim)(this.opts.deviceName, this.opts.platformVersion));

          case 31:
            device = context$2$0.sent;

            if (!device) {
              context$2$0.next = 40;
              break;
            }

            if (!(this.opts.reset || this.opts.fullReset)) {
              context$2$0.next = 39;
              break;
            }

            _logger2['default'].debug('Full reset requested. Cleaning and stopping simulator');
            context$2$0.next = 37;
            return _regeneratorRuntime.awrap(device.clean());

          case 37:
            context$2$0.next = 39;
            return _regeneratorRuntime.awrap(device.shutdown());

          case 39:
            return context$2$0.abrupt('return', { device: device, realDevice: false, udid: device.udid });

          case 40:

            // no device of this type exists, so create one
            _logger2['default'].info('Simluator udid not provided, using desired caps to create a new simulator');
            if (!this.opts.platformVersion) {
              _logger2['default'].info('No platformVersion specified. Using latest version \'' + this.iosSdkVersion + '\'');
              this.opts.platformVersion = this.iosSdkVersion;
            }
            context$2$0.next = 44;
            return _regeneratorRuntime.awrap(this.createSim());

          case 44:
            device = context$2$0.sent;
            return context$2$0.abrupt('return', { device: device, realDevice: false, udid: device.udid });

          case 46:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSim',
    value: function startSim() {
      return _regeneratorRuntime.async(function startSim$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.simBooted)(this.opts.device));

          case 2:
            if (context$2$0.sent) {
              context$2$0.next = 11;
              break;
            }

            _logger2['default'].info('Simulator with udid \'' + this.opts.udid + '\' not booted. Booting up now');
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.killAllSimulators)());

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.opts.device.run());

          case 8:
            this.lifecycleData.bootSim = true;
            context$2$0.next = 13;
            break;

          case 11:
            _logger2['default'].info('Simulator with udid \'' + this.opts.udid + '\' already booted');
            this.lifecycleData.bootSim = false;

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createSim',
    value: function createSim() {
      var sim;
      return _regeneratorRuntime.async(function createSim$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.lifecycleData.createSim = true;

            // create sim for caps
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _simulatorManagement.createSim)(this.caps, this.sessionId));

          case 3:
            sim = context$2$0.sent;

            _logger2['default'].info('Created simulator with udid \'' + sim.udid + '\'.');

            return context$2$0.abrupt('return', sim);

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'launchApp',
    value: function launchApp() {
      var APP_LAUNCH_TIMEOUT, checkStatus, retries;
      return _regeneratorRuntime.async(function launchApp$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            APP_LAUNCH_TIMEOUT = 20 * 1000;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.launch)(this.opts.device.udid, this.opts.bundleId));

          case 3:
            checkStatus = function checkStatus() {
              var response, currentApp;
              return _regeneratorRuntime.async(function checkStatus$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.proxyCommand('/status', 'GET'));

                  case 2:
                    response = context$3$0.sent;
                    currentApp = response.currentApp.bundleID;

                    if (!(currentApp !== this.opts.bundleId)) {
                      context$3$0.next = 6;
                      break;
                    }

                    throw new Error(this.opts.bundleId + ' not in foreground. ' + currentApp + ' is in foreground');

                  case 6:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            };

            _logger2['default'].info('Waiting for \'' + this.opts.bundleId + '\' to be in foreground');
            retries = parseInt(APP_LAUNCH_TIMEOUT / 200, 10);
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(retries, 200, checkStatus));

          case 8:
            _logger2['default'].info(this.opts.bundleId + ' is in foreground');

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startWdaSession',
    value: function startWdaSession(bundleId, processArguments) {
      var args, env, desired;
      return _regeneratorRuntime.async(function startWdaSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = processArguments ? processArguments.args : [];
            env = processArguments ? processArguments.env : {};
            desired = {
              desiredCapabilities: {
                bundleId: bundleId,
                arguments: args,
                environment: env,
                shouldWaitForQuiescence: true
              }
            };
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.proxyCommand('/session', 'POST', desired));

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    // Override Proxy methods from BaseDriver
  }, {
    key: 'proxyActive',
    value: function proxyActive() {
      return this.jwpProxyActive;
    }
  }, {
    key: 'getProxyAvoidList',
    value: function getProxyAvoidList() {
      if (this.isWebview()) {
        return NO_PROXY_WEB_LIST;
      }
      return NO_PROXY_NATIVE_LIST;
    }
  }, {
    key: 'canProxy',
    value: function canProxy() {
      return true;
    }
  }, {
    key: 'isSafari',
    value: function isSafari() {
      return !!this.safari;
    }
  }, {
    key: 'isRealDevice',
    value: function isRealDevice() {
      return this.opts.realDevice;
    }
  }, {
    key: 'isSimulator',
    value: function isSimulator() {
      return !this.opts.realDevice;
    }
  }, {
    key: 'isWebview',
    value: function isWebview() {
      return this.isSafari() || this.isWebContext();
    }
  }, {
    key: 'validateLocatorStrategy',
    value: function validateLocatorStrategy(strategy) {
      _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'validateLocatorStrategy', this).call(this, strategy, this.isWebContext());
    }
  }, {
    key: 'validateDesiredCaps',
    value: function validateDesiredCaps(caps) {
      // check with the base class, and return if it fails
      var res = _get(Object.getPrototypeOf(XCUITestDriver.prototype), 'validateDesiredCaps', this).call(this, caps);
      if (!res) return res;

      // make sure that the capabilities have one of `app` or `bundleId`
      if ((caps.browserName || '').toLowerCase() !== 'safari' && !caps.app && !caps.bundleId) {
        var msg = 'The desired capabilities must include either an app or a bundleId for iOS';
        _logger2['default'].errorAndThrow(msg);
      }

      var verifyProcessArgument = function verifyProcessArgument(processArguments) {
        if (!_lodash2['default'].isNil(processArguments.args) && !_lodash2['default'].isArray(processArguments.args)) {
          _logger2['default'].errorAndThrow('processArguments.args must be an array of string');
        }

        if (!_lodash2['default'].isNil(processArguments.env) && !_lodash2['default'].isObject(caps.processArguments.env)) {
          _logger2['default'].errorAndThrow('processArguments.env must be an object <key,value> pair {a:b, c:d}');
        }
      };

      // `processArguments` should be JSON string or an object with arguments and/ environment details
      if (caps.processArguments) {
        if (_lodash2['default'].isString(caps.processArguments)) {
          try {
            // try to parse the string as JSON
            caps.processArguments = JSON.parse(caps.processArguments);
            verifyProcessArgument(caps.processArguments);
          } catch (err) {
            _logger2['default'].errorAndThrow('processArguments must be a json format or an object with format {arguments : [], environment : {a:b, c:d}}. Both environment and argument can be null. Error : ' + err);
          }
        } else if (_lodash2['default'].isObject(caps.processArguments)) {
          verifyProcessArgument(caps.processArguments);
        } else {
          _logger2['default'].errorAndThrow('processArguments must be an object, or a string JSON object with format {arguments : [], environment : {a:b, c:d}}. Both environment and argument can be null.');
        }
      }

      // there is no point in having `keychainPath` without `keychainPassword`
      if (caps.keychainPath && !caps.keychainPassword || !caps.keychainPath && caps.keychainPassword) {
        _logger2['default'].errorAndThrow('If \'keychainPath\' is set, \'keychainPassword\' must also be set (and vice versa).');
      }

      // finally, return true since the superclass check passed, as did this
      return true;
    }
  }, {
    key: 'installApp',
    value: function installApp() {
      var pause;
      return _regeneratorRuntime.async(function installApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.isSafari()) {
              context$2$0.next = 2;
              break;
            }

            return context$2$0.abrupt('return');

          case 2:
            if (!(this.opts.autoLaunch === false)) {
              context$2$0.next = 4;
              break;
            }

            return context$2$0.abrupt('return');

          case 4:
            if (!this.isRealDevice()) {
              context$2$0.next = 9;
              break;
            }

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.installToRealDevice());

          case 7:
            context$2$0.next = 11;
            break;

          case 9:
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.installToSimulator());

          case 11:
            if (!_appiumSupport.util.hasValue(this.opts.iosInstallPause)) {
              context$2$0.next = 15;
              break;
            }

            pause = parseInt(this.opts.iosInstallPause, 10);
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(pause));

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'installToSimulator',
    value: function installToSimulator() {
      return _regeneratorRuntime.async(function installToSimulator$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(this.opts.fullReset && this.opts.bundleId)) {
              context$2$0.next = 4;
              break;
            }

            _logger2['default'].debug('Full reset requested. Removing app from device');
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.removeApp)(this.opts.device.udid, this.opts.bundleId));

          case 4:
            _logger2['default'].debug('Installing app \'' + this.opts.app + '\' on device');
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.installApp)(this.opts.device.udid, this.opts.app));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'installToRealDevice',
    value: function installToRealDevice() {
      return _regeneratorRuntime.async(function installToRealDevice$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.opts.udid) {
              context$2$0.next = 25;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.opts.device.isInstalled(this.opts.bundleId));

          case 3:
            if (!context$2$0.sent) {
              context$2$0.next = 15;
              break;
            }

            _logger2['default'].debug("App is installed.");

            if (!this.opts.fullReset) {
              context$2$0.next = 11;
              break;
            }

            _logger2['default'].debug('Full reset requested. Forcing app install after uninstall app');
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.opts.device.remove(this.opts.bundleId));

          case 9:
            context$2$0.next = 13;
            break;

          case 11:
            _logger2['default'].debug('Full reset not requested. No need to install.');
            return context$2$0.abrupt('return');

          case 13:
            context$2$0.next = 16;
            break;

          case 15:
            _logger2['default'].debug('App is not installed. Will try to install.');

          case 16:
            if (!this.opts.app) {
              context$2$0.next = 22;
              break;
            }

            context$2$0.next = 19;
            return _regeneratorRuntime.awrap(this.opts.device.install(this.opts.app));

          case 19:
            _logger2['default'].debug('App installed.');
            context$2$0.next = 23;
            break;

          case 22:
            _logger2['default'].debug("Real device specified but no ipa or app path, assuming bundle ID is " + "on device");

          case 23:
            context$2$0.next = 26;
            break;

          case 25:
            _logger2['default'].debug("No device id or app, not installing to real device.");

          case 26:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getIDeviceObj',
    value: function getIDeviceObj() {
      var iDevice, msg;
      return _regeneratorRuntime.async(function getIDeviceObj$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Creating iDevice object with udid ' + this.opts.udid);
            context$2$0.prev = 1;
            iDevice = new _iosDeploy2['default'](this.opts.udid);
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(iDevice.checkStatus());

          case 5:
            return context$2$0.abrupt('return', iDevice);

          case 8:
            context$2$0.prev = 8;
            context$2$0.t0 = context$2$0['catch'](1);
            msg = "Could not initialize ios-deploy make sure it is " + "installed and works on your system";

            _logger2['default'].error(msg);
            throw new Error(msg);

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 8]]);
    }
  }, {
    key: 'setInitialOrientation',
    value: function setInitialOrientation(orientation) {
      return _regeneratorRuntime.async(function setInitialOrientation$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(typeof orientation === 'string')) {
              context$2$0.next = 15;
              break;
            }

            orientation = orientation.toUpperCase();

            if (_lodash2['default'].includes(['LANDSCAPE', 'PORTRAIT'], orientation)) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].debug('Unable to set initial orientation to \'' + orientation + '\'');
            return context$2$0.abrupt('return');

          case 5:
            _logger2['default'].debug('Setting initial orientation to \'' + orientation + '\'');
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.proxyCommand('/orientation', 'POST', { orientation: orientation }));

          case 9:
            this.opts.curOrientation = orientation;
            context$2$0.next = 15;
            break;

          case 12:
            context$2$0.prev = 12;
            context$2$0.t0 = context$2$0['catch'](6);

            _logger2['default'].warn('Setting initial orientation failed with: ' + context$2$0.t0);

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 12]]);
    }
  }, {
    key: 'driverData',
    get: function get() {
      // TODO fill out resource info here
      return {};
    }
  }]);

  return XCUITestDriver;
})(_appiumBaseDriver.BaseDriver);

var _iteratorNormalCompletion = true;
var _didIteratorError = false;
var _iteratorError = undefined;

try {

  for (var _iterator = _getIterator(_lodash2['default'].toPairs(_commandsIndex2['default'])), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
    var _step$value = _slicedToArray(_step.value, 2);

    var cmd = _step$value[0];
    var fn = _step$value[1];

    XCUITestDriver.prototype[cmd] = fn;
  }
} catch (err) {
  _didIteratorError = true;
  _iteratorError = err;
} finally {
  try {
    if (!_iteratorNormalCompletion && _iterator['return']) {
      _iterator['return']();
    }
  } finally {
    if (_didIteratorError) {
      throw _iteratorError;
    }
  }
}

exports['default'] = XCUITestDriver;
exports.XCUITestDriver = XCUITestDriver;

// TODO add validation on caps
// TODO handle otherSessionData for multiple sessions

// TODO: this is when it is a real device. when we have a real object wire it in

// fail very early if the app doesn't actually exist

// the app name is a bundleId assign it to the bundleId property

// we have a bundle ID, but no app, or app is also a bundle

// check for supported build-in apps

// download if necessary

// check for a particular real device

// make sure it is a connected device. If not, the udid passed in is invalid

// figure out the correct simulator to use, given the desired capabilities

// check for an existing simulator

// TODO for now just kill all sims unless specified udid is booted.
// if booted, use it. if not booted, start it up
// if no udid, well lets see if we can start one up based on desired caps
// if we support multiple sims we need to change this

// if user has passed in desiredCaps.autoLaunch = false
// meaning they will manage app install / launching

// https://github.com/appium/appium/issues/6889

//This iDevice object could be ideviceinstaller (node-idevice) for future once we have ideviceinstaller working for ios 10
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFFdkMsZ0NBQUksSUFBSSw4REFBbUQsQ0FBQzs7Ozs7OztLQUdqRTs7O1NBNWhCYyxlQUFHOztBQUVoQixhQUFPLEVBQUUsQ0FBQztLQUNYOzs7U0FwREcsY0FBYzs7Ozs7Ozs7O0FBZ2xCcEIsb0NBQXNCLG9CQUFFLE9BQU8sNEJBQVUsNEdBQUU7OztRQUFqQyxHQUFHO1FBQUUsRUFBRTs7QUFDZixrQkFBYyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7R0FDcEM7Ozs7Ozs7Ozs7Ozs7Ozs7cUJBR2MsY0FBYztRQUNwQixjQUFjLEdBQWQsY0FBYyIsImZpbGUiOiJsaWIvZHJpdmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFzZURyaXZlciB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBmcywgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBsYXVuY2gsIGluc3RhbGxBcHAsIHJlbW92ZUFwcCB9IGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCB7IGV4dHJhY3RCdW5kbGVJZCB9IGZyb20gJ2lvcy1hcHAtdXRpbHMnO1xuaW1wb3J0IFdlYkRyaXZlckFnZW50IGZyb20gJy4vd2ViZHJpdmVyYWdlbnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBzaW1Cb290ZWQsIGNyZWF0ZVNpbSwgZ2V0RXhpc3RpbmdTaW0sIHJ1blNpbXVsYXRvclJlc2V0IH0gZnJvbSAnLi9zaW11bGF0b3ItbWFuYWdlbWVudCc7XG5pbXBvcnQgeyBraWxsQWxsU2ltdWxhdG9ycywgc2ltRXhpc3RzLCBnZXRTaW11bGF0b3IgfSBmcm9tICdhcHBpdW0taW9zLXNpbXVsYXRvcic7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgc2V0dGluZ3MgYXMgaW9zU2V0dGluZ3MsIGRlZmF1bHRTZXJ2ZXJDYXBzIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IGRlc2lyZWRDYXBDb25zdHJhaW50cyBmcm9tICcuL2Rlc2lyZWQtY2Fwcyc7XG5pbXBvcnQgY29tbWFuZHMgZnJvbSAnLi9jb21tYW5kcy9pbmRleCc7XG5pbXBvcnQgeyBkZXRlY3RVZGlkLCBnZXRBbmRDaGVja1hjb2RlVmVyc2lvbiwgZ2V0QW5kQ2hlY2tJb3NTZGtWZXJzaW9uIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBnZXRDb25uZWN0ZWREZXZpY2VzLCBydW5SZWFsRGV2aWNlUmVzZXQgfSBmcm9tICcuL3JlYWwtZGV2aWNlLW1hbmFnZW1lbnQnO1xuaW1wb3J0IElPU0RlcGxveSBmcm9tICcuL2lvcy1kZXBsb3knO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgdmVyc2lvbiB9IGZyb20gJy4uLy4uL3BhY2thZ2UuanNvbic7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgaW1wb3J0L25vLXVucmVzb2x2ZWRcblxuXG5jb25zdCBTQUZBUklfQlVORExFX0lEID0gJ2NvbS5hcHBsZS5tb2JpbGVzYWZhcmknO1xuXG5jb25zdCBOT19QUk9YWV9OQVRJVkVfTElTVCA9IFtcbiAgWydHRVQnLCAvY29udGV4dC9dLFxuICBbJ1BPU1QnLCAvY29udGV4dC9dLFxuICBbJ0dFVCcsIC93aW5kb3cvXSxcbiAgWydQT1NUJywgL3dpbmRvdy9dLFxuICBbJ0RFTEVURScsIC93aW5kb3cvXSxcbiAgWydQT1NUJywgL2V4ZWN1dGUvXSxcbiAgWydQT1NUJywgL2VsZW1lbnQkL10sXG4gIFsnUE9TVCcsIC9lbGVtZW50cyQvXSxcbiAgWydQT1NUJywgL3RpbWVvdXRzL10sXG4gIFsnR0VUJywgL2FsZXJ0X3RleHQvXSxcbiAgWydQT1NUJywgL2FsZXJ0X3RleHQvXSxcbiAgWydQT1NUJywgL2FjY2VwdF9hbGVydC9dLFxuICBbJ1BPU1QnLCAvZGlzbWlzc19hbGVydC9dLFxuICBbJ0dFVCcsIC9zb3VyY2UvXSxcbiAgWydQT1NUJywgL2FwcGl1bS9dLFxuICBbJ0dFVCcsIC9hcHBpdW0vXSxcbiAgWydQT1NUJywgL3RvdWNoL10sXG4gIFsnUE9TVCcsIC9jbGljay9dLFxuICBbJ0dFVCcsIC9sb2cvXSxcbiAgWydQT1NUJywgL2xvZy9dLFxuICBbJ1BPU1QnLCAvbW92ZXRvL10sXG4gIFsnUE9TVCcsIC9yZWNlaXZlX2FzeW5jX3Jlc3BvbnNlL10sIC8vIGFsd2F5cywgaW4gY2FzZSBjb250ZXh0IHN3aXRjaGVzIHdoaWxlIHdhaXRpbmdcbiAgWydHRVQnLCAvbG9jYXRpb24vXSxcbiAgWydHRVQnLCAvc2l6ZS9dLFxuICBbJ1BPU1QnLCAvdmFsdWUvXSxcbl07XG5jb25zdCBOT19QUk9YWV9XRUJfTElTVCA9IFtcbiAgWydHRVQnLCAvdGl0bGUvXSxcbiAgWydHRVQnLCAvdXJsL10sXG4gIFsnUE9TVCcsIC91cmwvXSxcbiAgWydQT1NUJywgL2VsZW1lbnQvXSxcbiAgWydQT1NUJywgL2JhY2svXSxcbiAgWydQT1NUJywgL2ZvcndhcmQvXSxcbiAgWydHRVQnLCAvYXR0cmlidXRlL10sXG4gIFsnR0VUJywgL3RleHQvXSxcbiAgWydQT1NUJywgL2NsZWFyL10sXG4gIFsnR0VUJywgL2VsZW1lbnQvXSxcbiAgWydQT1NUJywgL2NsaWNrL10sXG4gIFsnUE9TVCcsIC9yZWZyZXNoL10sXG4gIFsnR0VUJywgL2Nvb2tpZS9dLFxuICBbJ1BPU1QnLCAvY29va2llL10sXG4gIFsnREVMRVRFJywgL2Nvb2tpZS9dLFxuICBbJ1BPU1QnLCAvZnJhbWUvXSxcbl0uY29uY2F0KE5PX1BST1hZX05BVElWRV9MSVNUKTtcblxuY2xhc3MgWENVSVRlc3REcml2ZXIgZXh0ZW5kcyBCYXNlRHJpdmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSwgc2hvdWxkVmFsaWRhdGVDYXBzID0gdHJ1ZSkge1xuICAgIHN1cGVyKG9wdHMsIHNob3VsZFZhbGlkYXRlQ2Fwcyk7XG5cbiAgICBsb2cuZGVidWcoYFhDVUlUZXN0RHJpdmVyIHZlcnNpb246ICR7dmVyc2lvbn1gKTtcblxuICAgIHRoaXMuZGVzaXJlZENhcENvbnN0cmFpbnRzID0gZGVzaXJlZENhcENvbnN0cmFpbnRzO1xuXG4gICAgdGhpcy5sb2NhdG9yU3RyYXRlZ2llcyA9IFtcbiAgICAgICd4cGF0aCcsXG4gICAgICAnaWQnLFxuICAgICAgJ25hbWUnLFxuICAgICAgJ2NsYXNzIG5hbWUnLFxuICAgICAgJy1pb3MgcHJlZGljYXRlIHN0cmluZycsXG4gICAgICAnYWNjZXNzaWJpbGl0eSBpZCdcbiAgICBdO1xuICAgIHRoaXMud2ViTG9jYXRvclN0cmF0ZWdpZXMgPSBbXG4gICAgICAnbGluayB0ZXh0JyxcbiAgICAgICdjc3Mgc2VsZWN0b3InLFxuICAgICAgJ3RhZyBuYW1lJyxcbiAgICAgICdsaW5rIHRleHQnLFxuICAgICAgJ3BhcnRpYWwgbGluayB0ZXh0J1xuICAgIF07XG5cbiAgICB0aGlzLnJlc2V0SW9zKCk7XG4gIH1cblxuICByZXNldElvcyAoKSB7XG4gICAgdGhpcy5vcHRzID0gdGhpcy5vcHRzIHx8IHt9O1xuICAgIHRoaXMud2RhID0gbnVsbDtcbiAgICB0aGlzLm9wdHMuZGV2aWNlID0gbnVsbDtcbiAgICB0aGlzLmp3cFByb3h5QWN0aXZlID0gZmFsc2U7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IG51bGw7XG4gICAgdGhpcy5qd3BQcm94eUF2b2lkID0gW107XG4gICAgdGhpcy5zYWZhcmkgPSBmYWxzZTtcblxuICAgIC8vIHNvbWUgdGhpbmdzIHRoYXQgY29tbWFuZHMgaW1wb3J0ZWQgZnJvbSBhcHBpdW0taW9zLWRyaXZlciBuZWVkXG4gICAgdGhpcy5jdXJXZWJGcmFtZXMgPSBbXTtcbiAgICB0aGlzLndlYkVsZW1lbnRJZHMgPSBbXTtcbiAgICB0aGlzLl9jdXJyZW50VXJsID0gbnVsbDtcbiAgICB0aGlzLmN1ckNvbnRleHQgPSBudWxsO1xuICAgIHRoaXMueGNvZGVWZXJzaW9uID0gbnVsbDtcbiAgICB0aGlzLmlvc1Nka1ZlcnNpb24gPSBudWxsO1xuICAgIHRoaXMuY29udGV4dHMgPSBbXTtcbiAgICB0aGlzLmltcGxpY2l0V2FpdE1zID0gMDtcbiAgICB0aGlzLmFzeW5jbGliV2FpdE1zID0gMDtcbiAgICB0aGlzLnBhZ2VMb2FkTXMgPSA2MDAwO1xuICB9XG5cbiAgZ2V0IGRyaXZlckRhdGEgKCkge1xuICAgIC8vIFRPRE8gZmlsbCBvdXQgcmVzb3VyY2UgaW5mbyBoZXJlXG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgYXN5bmMgZ2V0U3RhdHVzICgpIHtcbiAgICBsZXQgd2RhU3RhdHVzID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgcmV0dXJuIHt3ZGE6IHdkYVN0YXR1c307XG4gIH1cblxuICBhc3luYyBjcmVhdGVTZXNzaW9uIChjYXBzKSB7XG4gICAgdGhpcy5saWZlY3ljbGVEYXRhID0ge307IC8vIHRoaXMgaXMgdXNlZCBmb3Iga2VlcGluZyB0cmFjayBvZiB0aGUgc3RhdGUgd2Ugc3RhcnQgc28gd2hlbiB3ZSBkZWxldGUgdGhlIHNlc3Npb24gd2UgY2FuIHB1dCB0aGluZ3MgYmFja1xuICAgIHRyeSB7XG4gICAgICAvLyBUT0RPIGFkZCB2YWxpZGF0aW9uIG9uIGNhcHNcbiAgICAgIC8vIFRPRE8gaGFuZGxlIG90aGVyU2Vzc2lvbkRhdGEgZm9yIG11bHRpcGxlIHNlc3Npb25zXG4gICAgICBsZXQgW3Nlc3Npb25JZF0gPSBhd2FpdCBzdXBlci5jcmVhdGVTZXNzaW9uKGNhcHMpO1xuICAgICAgdGhpcy5vcHRzLnNlc3Npb25JZCA9IHNlc3Npb25JZDtcblxuICAgICAgYXdhaXQgdGhpcy5zdGFydCgpO1xuXG4gICAgICAvLyBtZXJnZSBzZXJ2ZXIgY2FwYWJpbGl0aWVzICsgZGVzaXJlZCBjYXBhYmlsaXRpZXNcbiAgICAgIGNhcHMgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0U2VydmVyQ2FwcywgY2Fwcyk7XG4gICAgICByZXR1cm4gW3Nlc3Npb25JZCwgY2Fwc107XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLmVycm9yKGUpO1xuICAgICAgYXdhaXQgdGhpcy5kZWxldGVTZXNzaW9uKCk7XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICgpIHtcbiAgICB0aGlzLm9wdHMubm9SZXNldCA9ICEhdGhpcy5vcHRzLm5vUmVzZXQ7XG4gICAgdGhpcy5vcHRzLmZ1bGxSZXNldCA9ICEhdGhpcy5vcHRzLmZ1bGxSZXNldDtcblxuICAgIGlmICghdGhpcy54Y29kZVZlcnNpb24pIHtcbiAgICAgIHRoaXMueGNvZGVWZXJzaW9uID0gYXdhaXQgZ2V0QW5kQ2hlY2tYY29kZVZlcnNpb24oKTtcbiAgICAgIGxvZy5kZWJ1ZyhgWGNvZGUgdmVyc2lvbiBzZXQgdG8gJyR7dGhpcy54Y29kZVZlcnNpb24udmVyc2lvblN0cmluZ30nYCk7XG4gICAgfVxuXG4gICAgdGhpcy5pb3NTZGtWZXJzaW9uID0gYXdhaXQgZ2V0QW5kQ2hlY2tJb3NTZGtWZXJzaW9uKCk7XG4gICAgbG9nLmRlYnVnKGBpT1MgU0RLIFZlcnNpb24gc2V0IHRvICcke3RoaXMuaW9zU2RrVmVyc2lvbn0nYCk7XG5cbiAgICBpZiAodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiAmJiBwYXJzZUZsb2F0KHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24pIDwgOS4zKSB7XG4gICAgICB0aHJvdyBFcnJvcihgUGxhdGZvcm0gdmVyc2lvbiBtdXN0IGJlIDkuMyBvciBhYm92ZS4gJyR7dGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbn0nIGlzIG5vdCBzdXBwb3J0ZWQuYCk7XG4gICAgfVxuXG4gICAgbGV0IHsgZGV2aWNlLCB1ZGlkLCByZWFsRGV2aWNlIH0gPSBhd2FpdCB0aGlzLmRldGVybWluZURldmljZSgpO1xuICAgIGxvZy5pbmZvKGBEZXRlcm1pbmluZyBkZXZpY2UgdG8gcnVuIHRlc3RzIG9uOiB1ZGlkOiAnJHt1ZGlkfScsIHJlYWwgZGV2aWNlOiAke3JlYWxEZXZpY2V9YCk7XG4gICAgdGhpcy5vcHRzLmRldmljZSA9IGRldmljZTtcbiAgICB0aGlzLm9wdHMudWRpZCA9IHVkaWQ7XG4gICAgdGhpcy5vcHRzLnJlYWxEZXZpY2UgPSByZWFsRGV2aWNlO1xuXG4gICAgLy8gYXQgdGhpcyBwb2ludCBpZiB0aGVyZSBpcyBubyBwbGF0Zm9ybVZlcnNpb24sIGdldCBpdCBmcm9tIHRoZSBkZXZpY2VcbiAgICBpZiAoIXRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24pIHtcbiAgICAgIGlmICh0aGlzLm9wdHMuZGV2aWNlICYmIF8uaXNGdW5jdGlvbih0aGlzLm9wdHMuZGV2aWNlLmdldFBsYXRmb3JtVmVyc2lvbikpIHtcbiAgICAgICAgdGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiA9IGF3YWl0IHRoaXMub3B0cy5kZXZpY2UuZ2V0UGxhdGZvcm1WZXJzaW9uKCk7XG4gICAgICAgIGxvZy5pbmZvKGBObyBwbGF0Zm9ybVZlcnNpb24gc3BlY2lmaWVkLiBVc2luZyBkZXZpY2UgdmVyc2lvbjogJyR7dGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbn0nYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBUT0RPOiB0aGlzIGlzIHdoZW4gaXQgaXMgYSByZWFsIGRldmljZS4gd2hlbiB3ZSBoYXZlIGEgcmVhbCBvYmplY3Qgd2lyZSBpdCBpblxuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLm9wdHMuYnJvd3Nlck5hbWUpIHtcbiAgICAgIGxvZy5pbmZvKCdTYWZhcmkgdGVzdCByZXF1ZXN0ZWQnKTtcbiAgICAgIHRoaXMuc2FmYXJpID0gdHJ1ZTtcbiAgICAgIHRoaXMub3B0cy5hcHAgPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLm9wdHMucHJvY2Vzc0FyZ3VtZW50cyA9IHRoaXMub3B0cy5wcm9jZXNzQXJndW1lbnRzIHx8IHt9O1xuICAgICAgdGhpcy5vcHRzLmJ1bmRsZUlkID0gU0FGQVJJX0JVTkRMRV9JRDtcbiAgICAgIHRoaXMuX2N1cnJlbnRVcmwgPSB0aGlzLm9wdHMuc2FmYXJpSW5pdGlhbFVybCB8fCAoXG4gICAgICAgIHRoaXMuaXNSZWFsRGV2aWNlKCkgP1xuICAgICAgICAnaHR0cDovL2FwcGl1bS5pbycgOlxuICAgICAgICBgaHR0cDovLyR7dGhpcy5vcHRzLmFkZHJlc3N9OiR7dGhpcy5vcHRzLnBvcnR9L3dlbGNvbWVgXG4gICAgICApO1xuICAgICAgdGhpcy5vcHRzLnByb2Nlc3NBcmd1bWVudHMuYXJncyA9IFsnLXUnLCB0aGlzLl9jdXJyZW50VXJsXTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5jb25maWd1cmVBcHAoKTtcbiAgICB9XG5cbiAgICAvLyBmYWlsIHZlcnkgZWFybHkgaWYgdGhlIGFwcCBkb2Vzbid0IGFjdHVhbGx5IGV4aXN0XG4gICAgaWYgKHRoaXMub3B0cy5hcHApIHtcbiAgICAgIGF3YWl0IHRoaXMuY2hlY2tBcHBQcmVzZW50KCk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLm9wdHMuYnVuZGxlSWQpIHtcbiAgICAgIHRoaXMub3B0cy5idW5kbGVJZCA9IGF3YWl0IHRoaXMuZXh0cmFjdEJ1bmRsZUlkKHRoaXMub3B0cy5hcHApO1xuICAgIH1cblxuICAgIC8vIGhhbmRsZSBsb2dnaW5nXG4gICAgdGhpcy5sb2dzID0ge307XG4gICAgYXdhaXQgdGhpcy5zdGFydExvZ0NhcHR1cmUoKTtcblxuICAgIGxvZy5pbmZvKGBTZXR0aW5nIHVwICR7dGhpcy5pc1JlYWxEZXZpY2UoKSA/ICdyZWFsIGRldmljZScgOiAnc2ltdWxhdG9yJ31gKTtcbiAgICBpZiAoIXRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIHRoaXMubG9jYWxlQ29uZmlnID0gYXdhaXQgaW9zU2V0dGluZ3Muc2V0TG9jYWxlKHRoaXMub3B0cy5kZXZpY2UsIHRoaXMub3B0cywge30sIHRoaXMuaXNTYWZhcmkoKSk7XG4gICAgICBhd2FpdCBpb3NTZXR0aW5ncy5zZXRQcmVmZXJlbmNlcyh0aGlzLm9wdHMuZGV2aWNlLCB0aGlzLm9wdHMsIHRoaXMuaXNTYWZhcmkoKSk7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0U2ltKCk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5pbnN0YWxsQXBwKCk7XG5cbiAgICBhd2FpdCB0aGlzLnN0YXJ0V2RhKHRoaXMub3B0cy5zZXNzaW9uSWQsIHJlYWxEZXZpY2UpO1xuXG4gICAgYXdhaXQgdGhpcy5zZXRJbml0aWFsT3JpZW50YXRpb24odGhpcy5vcHRzLm9yaWVudGF0aW9uKTtcblxuICAgIGlmICh0aGlzLmlzU2FmYXJpKCkgfHwgdGhpcy5vcHRzLmF1dG9XZWJ2aWV3KSB7XG4gICAgICBsb2cuZGVidWcoJ1dhaXRpbmcgZm9yIGluaXRpYWwgd2VidmlldycpO1xuICAgICAgYXdhaXQgdGhpcy5uYXZUb0luaXRpYWxXZWJ2aWV3KCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc3RhcnRXZGEgKHNlc3Npb25JZCwgcmVhbERldmljZSkge1xuICAgIHRoaXMud2RhID0gbmV3IFdlYkRyaXZlckFnZW50KHRoaXMub3B0cyk7XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy53ZGEubGF1bmNoKHNlc3Npb25JZCwgcmVhbERldmljZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoKGVyci5tZXNzYWdlIHx8ICcnKS5pbmRleE9mKCd4Y29kZWJ1aWxkIGZhaWxlZCB3aXRoIGNvZGUgNjUnKSA9PT0gLTEpIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgICAgLy8gWGNvZGUgZXJyb3IgY29kZSA2NSBtZWFucyB0aGF0IHRoZSBXREEgYXBwIGlzIHN0aWxsIGJlaW5nIGluc3RhbGxlZFxuICAgICAgLy8gYW5kIHhjb2RlYnVpbGQgY2FuJ3QgZG8gaXRzIGJ1c2luZXNzLCBzbyBpdCBpcyByZWFzb25hYmxlIHRvIHJldHJ5XG4gICAgICBsb2cuZGVidWcoJ3hjb2RlYnVpbGQgZmFpbHVyZSB3YXJyYW50cyByZXRyeS4gUmV0cnlpbmcuLi4nKTtcbiAgICAgIGF3YWl0IHRoaXMud2RhLnF1aXQoKTtcbiAgICAgIGF3YWl0IHRoaXMud2RhLmxhdW5jaChzZXNzaW9uSWQsIHJlYWxEZXZpY2UpO1xuICAgIH1cblxuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLndkYS5wcm94eVJlcVJlcy5iaW5kKHRoaXMud2RhKTtcbiAgICB0aGlzLmp3cFByb3h5QWN0aXZlID0gdHJ1ZTtcblxuICAgIGF3YWl0IHRoaXMuc3RhcnRXZGFTZXNzaW9uKHRoaXMub3B0cy5idW5kbGVJZCwgdGhpcy5vcHRzLnByb2Nlc3NBcmd1bWVudHMpO1xuICB9XG5cbiAgLy8gY3JlYXRlIGFuIGFsaWFzIHNvIHdlIGNhbiBhY3R1YWxseSB1bml0IHRlc3QgY3JlYXRlU2Vzc2lvbiBieSBzdHViYmluZ1xuICAvLyB0aGlzXG4gIGFzeW5jIGV4dHJhY3RCdW5kbGVJZCAoYXBwKSB7XG4gICAgcmV0dXJuIGF3YWl0IGV4dHJhY3RCdW5kbGVJZChhcHApO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgYXdhaXQgdGhpcy5zdG9wKCk7XG5cbiAgICBhd2FpdCBzdXBlci5kZWxldGVTZXNzaW9uKCk7XG4gIH1cblxuICBhc3luYyBzdG9wICgpIHtcbiAgICB0aGlzLmp3cFByb3h5QWN0aXZlID0gZmFsc2U7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IG51bGw7XG5cbiAgICBpZiAodGhpcy53ZGEgJiYgdGhpcy53ZGEuandwcm94eSkge1xuICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9zZXNzaW9uLyR7dGhpcy5zZXNzaW9uSWR9YCwgJ0RFTEVURScpO1xuICAgICAgYXdhaXQgdGhpcy53ZGEucXVpdCgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgICBsb2cuZGVidWcoJ0luIGEgd2ViIHNlc3Npb24uIFJlbW92aW5nIHJlbW90ZSBkZWJ1Z2dlcicpO1xuICAgICAgYXdhaXQgdGhpcy5zdG9wUmVtb3RlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIGF3YWl0IHJ1blJlYWxEZXZpY2VSZXNldCh0aGlzLm9wdHMuZGV2aWNlLCB0aGlzLm9wdHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCBydW5TaW11bGF0b3JSZXNldCh0aGlzLm9wdHMuZGV2aWNlLCB0aGlzLm9wdHMpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5vcHRzLm5vUmVzZXQgJiYgISF0aGlzLm9wdHMuZGV2aWNlKSB7XG4gICAgICBsb2cuZGVidWcoJ1Jlc2V0dGluZyBzaW11bGF0b3InKTtcbiAgICAgIGlmICh0aGlzLmxpZmVjeWNsZURhdGEuYm9vdFNpbSkge1xuICAgICAgICBsb2cuZGVidWcoJ1NodXR0aW5nIGRvd24gc2ltdWxhdG9yJyk7XG4gICAgICAgIGF3YWl0IHRoaXMub3B0cy5kZXZpY2Uuc2h1dGRvd24oKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmxpZmVjeWNsZURhdGEuY3JlYXRlU2ltKSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnRGVsZXRpbmcgc2ltdWxhdG9yIGNyZWF0ZWQgZm9yIHRoaXMgcnVuJyk7XG4gICAgICAgIGF3YWl0IHRoaXMub3B0cy5kZXZpY2UuZGVsZXRlKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzRW1wdHkodGhpcy5sb2dzKSkge1xuICAgICAgdGhpcy5sb2dzLnN5c2xvZy5zdG9wQ2FwdHVyZSgpO1xuICAgICAgdGhpcy5sb2dzID0ge307XG4gICAgfVxuXG4gICAgdGhpcy5yZXNldElvcygpO1xuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZUNvbW1hbmQgKGNtZCwgLi4uYXJncykge1xuICAgIGxvZy5kZWJ1ZyhgRXhlY3V0aW5nIGNvbW1hbmQgJyR7Y21kfSdgKTtcbiAgICBpZiAoY21kID09PSAncmVjZWl2ZUFzeW5jUmVzcG9uc2UnKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5yZWNlaXZlQXN5bmNSZXNwb25zZSguLi5hcmdzKTtcbiAgICB9XG4gICAgcmV0dXJuIGF3YWl0IHN1cGVyLmV4ZWN1dGVDb21tYW5kKGNtZCwgLi4uYXJncyk7XG4gIH1cblxuXG4gIGFzeW5jIGNoZWNrQXBwUHJlc2VudCAoKSB7XG4gICAgbG9nLmRlYnVnKFwiQ2hlY2tpbmcgd2hldGhlciBhcHAgaXMgYWN0dWFsbHkgcHJlc2VudFwiKTtcbiAgICBpZiAoIShhd2FpdCBmcy5leGlzdHModGhpcy5vcHRzLmFwcCkpKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ291bGQgbm90IGZpbmQgYXBwIGF0ICR7dGhpcy5vcHRzLmFwcH1gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjb25maWd1cmVBcHAgKCkge1xuICAgIGZ1bmN0aW9uIGFwcElzUGFja2FnZU9yQnVuZGxlIChhcHApIHtcbiAgICAgIHJldHVybiAoL14oW2EtekEtWjAtOVxcLV9dK1xcLlthLXpBLVowLTlcXC1fXSspKyQvKS50ZXN0KGFwcCk7XG4gICAgfVxuXG4gICAgLy8gdGhlIGFwcCBuYW1lIGlzIGEgYnVuZGxlSWQgYXNzaWduIGl0IHRvIHRoZSBidW5kbGVJZCBwcm9wZXJ0eVxuICAgIGlmICghdGhpcy5vcHRzLmJ1bmRsZUlkICYmIGFwcElzUGFja2FnZU9yQnVuZGxlKHRoaXMub3B0cy5hcHApKSB7XG4gICAgICB0aGlzLm9wdHMuYnVuZGxlSWQgPSB0aGlzLm9wdHMuYXBwO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyB3ZSBoYXZlIGEgYnVuZGxlIElELCBidXQgbm8gYXBwLCBvciBhcHAgaXMgYWxzbyBhIGJ1bmRsZVxuICAgIGlmICgodGhpcy5vcHRzLmJ1bmRsZUlkICYmIGFwcElzUGFja2FnZU9yQnVuZGxlKHRoaXMub3B0cy5idW5kbGVJZCkpICYmXG4gICAgICAgICh0aGlzLm9wdHMuYXBwID09PSAnJyB8fCBhcHBJc1BhY2thZ2VPckJ1bmRsZSh0aGlzLm9wdHMuYXBwKSkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnQXBwIGlzIGFuIGlPUyBidW5kbGUsIHdpbGwgYXR0ZW1wdCB0byBydW4gYXMgcHJlLWV4aXN0aW5nJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG5cbiAgICAvLyBjaGVjayBmb3Igc3VwcG9ydGVkIGJ1aWxkLWluIGFwcHNcbiAgICBpZiAodGhpcy5vcHRzLmFwcCAmJiB0aGlzLm9wdHMuYXBwLnRvTG93ZXJDYXNlKCkgPT09ICdzZXR0aW5ncycpIHtcbiAgICAgIHRoaXMub3B0cy5idW5kbGVJZCA9ICdjb20uYXBwbGUuUHJlZmVyZW5jZXMnO1xuICAgICAgdGhpcy5vcHRzLmFwcCA9IG51bGw7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmICh0aGlzLm9wdHMuYXBwICYmIHRoaXMub3B0cy5hcHAudG9Mb3dlckNhc2UoKSA9PT0gJ2NhbGVuZGFyJykge1xuICAgICAgdGhpcy5vcHRzLmJ1bmRsZUlkID0gJ2NvbS5hcHBsZS5tb2JpbGVjYWwnO1xuICAgICAgdGhpcy5vcHRzLmFwcCA9IG51bGw7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIGRvd25sb2FkIGlmIG5lY2Vzc2FyeVxuICAgICAgdGhpcy5vcHRzLmFwcCA9IGF3YWl0IHRoaXMuaGVscGVycy5jb25maWd1cmVBcHAodGhpcy5vcHRzLmFwcCwgJy5hcHAnLCB0aGlzLm9wdHMubW91bnRSb290LCB0aGlzLm9wdHMud2luZG93c1NoYXJlVXNlck5hbWUsIHRoaXMub3B0cy53aW5kb3dzU2hhcmVQYXNzd29yZCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3IoZXJyKTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYEJhZCBhcHA6ICR7dGhpcy5vcHRzLmFwcH0uIEFwcCBwYXRocyBuZWVkIHRvIGJlIGFic29sdXRlLCBvciByZWxhdGl2ZSB0byB0aGUgYXBwaXVtIGAgK1xuICAgICAgICAnc2VydmVyIGluc3RhbGwgZGlyLCBvciBhIFVSTCB0byBjb21wcmVzc2VkIGZpbGUsIG9yIGEgc3BlY2lhbCBhcHAgbmFtZS4nKTtcbiAgICB9XG4gIH1cblxuXG4gIGFzeW5jIGRldGVybWluZURldmljZSAoKSB7XG4gICAgLy8gaW4gdGhlIG9uZSBjYXNlIHdoZXJlIHdlIGNyZWF0ZSBhIHNpbSwgd2Ugd2lsbCBzZXQgdGhpcyBzdGF0ZVxuICAgIHRoaXMubGlmZWN5Y2xlRGF0YS5jcmVhdGVTaW0gPSBmYWxzZTtcblxuICAgIC8vIGlmIHdlIGdldCBnZW5lcmljIG5hbWVzLCB0cmFuc2xhdGUgdGhlbVxuICAgIHRoaXMub3B0cy5kZXZpY2VOYW1lID0gKGZ1bmN0aW9uIHRyYW5zbGF0ZURldmljZU5hbWUgKGRuID0gJycpIHtcbiAgICAgIGxldCBkZXZpY2VOYW1lID0gZG47XG4gICAgICBpZiAoZG4udG9Mb3dlckNhc2UoKSA9PT0gJ2lwaG9uZSBzaW11bGF0b3InKSB7XG4gICAgICAgIGRldmljZU5hbWUgPSAnaVBob25lIDYnO1xuICAgICAgfSBlbHNlIGlmIChkbi50b0xvd2VyQ2FzZSgpID09PSAnaXBhZCBzaW11bGF0b3InKSB7XG4gICAgICAgIGRldmljZU5hbWUgPSAnaVBhZCAyJztcbiAgICAgIH1cbiAgICAgIGlmIChkZXZpY2VOYW1lICE9PSBkbikge1xuICAgICAgICBsb2cuZGVidWcoYENoYW5naW5nIGRldmljZU5hbWUgZnJvbSAnJHtkbn0nIHRvICcke2RldmljZU5hbWV9J2ApO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGRldmljZU5hbWU7XG4gICAgfSkodGhpcy5vcHRzLmRldmljZU5hbWUpO1xuXG4gICAgLy8gY2hlY2sgZm9yIGEgcGFydGljdWxhciBzaW11bGF0b3JcbiAgICBpZiAodGhpcy5vcHRzLnVkaWQgJiYgKGF3YWl0IHNpbUV4aXN0cyh0aGlzLm9wdHMudWRpZCkpKSB7XG4gICAgICBsZXQgZGV2aWNlID0gYXdhaXQgZ2V0U2ltdWxhdG9yKHRoaXMub3B0cy51ZGlkKTtcbiAgICAgIHJldHVybiB7ZGV2aWNlLCByZWFsRGV2aWNlOiBmYWxzZSwgdWRpZDogdGhpcy5vcHRzLnVkaWR9O1xuICAgIH1cblxuICAgIC8vIGNoZWNrIGZvciBhIHBhcnRpY3VsYXIgcmVhbCBkZXZpY2VcbiAgICBpZiAodGhpcy5vcHRzLnVkaWQpIHtcbiAgICAgIGlmICh0aGlzLm9wdHMudWRpZC50b0xvd2VyQ2FzZSgpID09PSAnYXV0bycpIHtcbiAgICAgICAgdGhpcy5vcHRzLnVkaWQgPSBhd2FpdCBkZXRlY3RVZGlkKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBtYWtlIHN1cmUgaXQgaXMgYSBjb25uZWN0ZWQgZGV2aWNlLiBJZiBub3QsIHRoZSB1ZGlkIHBhc3NlZCBpbiBpcyBpbnZhbGlkXG4gICAgICAgIGxldCBkZXZpY2VzID0gYXdhaXQgZ2V0Q29ubmVjdGVkRGV2aWNlcygpO1xuICAgICAgICBsb2cuZGVidWcoYEF2YWlsYWJsZSBkZXZpY2VzOiAke2RldmljZXMuam9pbignLCAnKX1gKTtcbiAgICAgICAgaWYgKGRldmljZXMuaW5kZXhPZih0aGlzLm9wdHMudWRpZCkgPT09IC0xKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGRldmljZSBvciBzaW11bGF0b3IgVURJRDogJyR7dGhpcy5vcHRzLnVkaWR9J2ApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGxldCBkZXZpY2UgPSBhd2FpdCB0aGlzLmdldElEZXZpY2VPYmooKTtcbiAgICAgIHJldHVybiB7ZGV2aWNlLCByZWFsRGV2aWNlOiB0cnVlLCB1ZGlkOiB0aGlzLm9wdHMudWRpZH07XG4gICAgfVxuXG4gICAgLy8gZmlndXJlIG91dCB0aGUgY29ycmVjdCBzaW11bGF0b3IgdG8gdXNlLCBnaXZlbiB0aGUgZGVzaXJlZCBjYXBhYmlsaXRpZXNcbiAgICBsZXQgZGV2aWNlID0gYXdhaXQgZ2V0RXhpc3RpbmdTaW0odGhpcy5vcHRzLmRldmljZU5hbWUsIHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24pO1xuXG4gICAgLy8gY2hlY2sgZm9yIGFuIGV4aXN0aW5nIHNpbXVsYXRvclxuICAgIGlmIChkZXZpY2UpIHtcbiAgICAgIGlmICh0aGlzLm9wdHMucmVzZXQgfHwgdGhpcy5vcHRzLmZ1bGxSZXNldCkge1xuICAgICAgICBsb2cuZGVidWcoJ0Z1bGwgcmVzZXQgcmVxdWVzdGVkLiBDbGVhbmluZyBhbmQgc3RvcHBpbmcgc2ltdWxhdG9yJyk7XG4gICAgICAgIGF3YWl0IGRldmljZS5jbGVhbigpO1xuICAgICAgICBhd2FpdCBkZXZpY2Uuc2h1dGRvd24oKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7ZGV2aWNlLCByZWFsRGV2aWNlOiBmYWxzZSwgdWRpZDogZGV2aWNlLnVkaWR9O1xuICAgIH1cblxuICAgIC8vIG5vIGRldmljZSBvZiB0aGlzIHR5cGUgZXhpc3RzLCBzbyBjcmVhdGUgb25lXG4gICAgbG9nLmluZm8oJ1NpbWx1YXRvciB1ZGlkIG5vdCBwcm92aWRlZCwgdXNpbmcgZGVzaXJlZCBjYXBzIHRvIGNyZWF0ZSBhIG5ldyBzaW11bGF0b3InKTtcbiAgICBpZiAoIXRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24pIHtcbiAgICAgIGxvZy5pbmZvKGBObyBwbGF0Zm9ybVZlcnNpb24gc3BlY2lmaWVkLiBVc2luZyBsYXRlc3QgdmVyc2lvbiAnJHt0aGlzLmlvc1Nka1ZlcnNpb259J2ApO1xuICAgICAgdGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiA9IHRoaXMuaW9zU2RrVmVyc2lvbjtcbiAgICB9XG4gICAgZGV2aWNlID0gYXdhaXQgdGhpcy5jcmVhdGVTaW0oKTtcbiAgICByZXR1cm4ge2RldmljZSwgcmVhbERldmljZTogZmFsc2UsIHVkaWQ6IGRldmljZS51ZGlkfTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2ltICgpIHtcbiAgICAvLyBUT0RPIGZvciBub3cganVzdCBraWxsIGFsbCBzaW1zIHVubGVzcyBzcGVjaWZpZWQgdWRpZCBpcyBib290ZWQuXG4gICAgLy8gaWYgYm9vdGVkLCB1c2UgaXQuIGlmIG5vdCBib290ZWQsIHN0YXJ0IGl0IHVwXG4gICAgLy8gaWYgbm8gdWRpZCwgd2VsbCBsZXRzIHNlZSBpZiB3ZSBjYW4gc3RhcnQgb25lIHVwIGJhc2VkIG9uIGRlc2lyZWQgY2Fwc1xuICAgIC8vIGlmIHdlIHN1cHBvcnQgbXVsdGlwbGUgc2ltcyB3ZSBuZWVkIHRvIGNoYW5nZSB0aGlzXG5cbiAgICBpZiAoIWF3YWl0IHNpbUJvb3RlZCh0aGlzLm9wdHMuZGV2aWNlKSkge1xuICAgICAgbG9nLmluZm8oYFNpbXVsYXRvciB3aXRoIHVkaWQgJyR7dGhpcy5vcHRzLnVkaWR9JyBub3QgYm9vdGVkLiBCb290aW5nIHVwIG5vd2ApO1xuICAgICAgYXdhaXQga2lsbEFsbFNpbXVsYXRvcnMoKTtcbiAgICAgIGF3YWl0IHRoaXMub3B0cy5kZXZpY2UucnVuKCk7XG4gICAgICB0aGlzLmxpZmVjeWNsZURhdGEuYm9vdFNpbSA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5pbmZvKGBTaW11bGF0b3Igd2l0aCB1ZGlkICcke3RoaXMub3B0cy51ZGlkfScgYWxyZWFkeSBib290ZWRgKTtcbiAgICAgIHRoaXMubGlmZWN5Y2xlRGF0YS5ib290U2ltID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY3JlYXRlU2ltICgpIHtcbiAgICB0aGlzLmxpZmVjeWNsZURhdGEuY3JlYXRlU2ltID0gdHJ1ZTtcblxuICAgIC8vIGNyZWF0ZSBzaW0gZm9yIGNhcHNcbiAgICBsZXQgc2ltID0gYXdhaXQgY3JlYXRlU2ltKHRoaXMuY2FwcywgdGhpcy5zZXNzaW9uSWQpO1xuICAgIGxvZy5pbmZvKGBDcmVhdGVkIHNpbXVsYXRvciB3aXRoIHVkaWQgJyR7c2ltLnVkaWR9Jy5gKTtcblxuICAgIHJldHVybiBzaW07XG4gIH1cblxuICBhc3luYyBsYXVuY2hBcHAgKCkge1xuICAgIGNvbnN0IEFQUF9MQVVOQ0hfVElNRU9VVCA9IDIwICogMTAwMDtcblxuICAgIGF3YWl0IGxhdW5jaCh0aGlzLm9wdHMuZGV2aWNlLnVkaWQsIHRoaXMub3B0cy5idW5kbGVJZCk7XG5cbiAgICBsZXQgY2hlY2tTdGF0dXMgPSBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgIGxldCBjdXJyZW50QXBwID0gcmVzcG9uc2UuY3VycmVudEFwcC5idW5kbGVJRDtcbiAgICAgIGlmIChjdXJyZW50QXBwICE9PSB0aGlzLm9wdHMuYnVuZGxlSWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3RoaXMub3B0cy5idW5kbGVJZH0gbm90IGluIGZvcmVncm91bmQuICR7Y3VycmVudEFwcH0gaXMgaW4gZm9yZWdyb3VuZGApO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBsb2cuaW5mbyhgV2FpdGluZyBmb3IgJyR7dGhpcy5vcHRzLmJ1bmRsZUlkfScgdG8gYmUgaW4gZm9yZWdyb3VuZGApO1xuICAgIGxldCByZXRyaWVzID0gcGFyc2VJbnQoQVBQX0xBVU5DSF9USU1FT1VUIC8gMjAwLCAxMCk7XG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbChyZXRyaWVzLCAyMDAsIGNoZWNrU3RhdHVzKTtcbiAgICBsb2cuaW5mbyhgJHt0aGlzLm9wdHMuYnVuZGxlSWR9IGlzIGluIGZvcmVncm91bmRgKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0V2RhU2Vzc2lvbiAoYnVuZGxlSWQsIHByb2Nlc3NBcmd1bWVudHMpIHtcbiAgICBsZXQgYXJncyA9IHByb2Nlc3NBcmd1bWVudHMgPyBwcm9jZXNzQXJndW1lbnRzLmFyZ3MgOiBbXTtcbiAgICBsZXQgZW52ID0gcHJvY2Vzc0FyZ3VtZW50cyA/IHByb2Nlc3NBcmd1bWVudHMuZW52IDoge307XG5cbiAgICBsZXQgZGVzaXJlZCA9IHtcbiAgICAgIGRlc2lyZWRDYXBhYmlsaXRpZXM6IHtcbiAgICAgICAgYnVuZGxlSWQsXG4gICAgICAgIGFyZ3VtZW50czogYXJncyxcbiAgICAgICAgZW52aXJvbm1lbnQ6IGVudixcbiAgICAgICAgc2hvdWxkV2FpdEZvclF1aWVzY2VuY2U6IHRydWVcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCBkZXNpcmVkKTtcbiAgfVxuXG4gIC8vIE92ZXJyaWRlIFByb3h5IG1ldGhvZHMgZnJvbSBCYXNlRHJpdmVyXG4gIHByb3h5QWN0aXZlICgpIHtcbiAgICByZXR1cm4gdGhpcy5qd3BQcm94eUFjdGl2ZTtcbiAgfVxuXG4gIGdldFByb3h5QXZvaWRMaXN0ICgpIHtcbiAgICBpZiAodGhpcy5pc1dlYnZpZXcoKSkge1xuICAgICAgcmV0dXJuIE5PX1BST1hZX1dFQl9MSVNUO1xuICAgIH1cbiAgICByZXR1cm4gTk9fUFJPWFlfTkFUSVZFX0xJU1Q7XG4gIH1cblxuICBjYW5Qcm94eSAoKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBpc1NhZmFyaSAoKSB7XG4gICAgcmV0dXJuICEhdGhpcy5zYWZhcmk7XG4gIH1cblxuICBpc1JlYWxEZXZpY2UgKCkge1xuICAgIHJldHVybiB0aGlzLm9wdHMucmVhbERldmljZTtcbiAgfVxuXG4gIGlzU2ltdWxhdG9yICgpIHtcbiAgICByZXR1cm4gIXRoaXMub3B0cy5yZWFsRGV2aWNlO1xuICB9XG5cbiAgaXNXZWJ2aWV3ICgpIHtcbiAgICByZXR1cm4gdGhpcy5pc1NhZmFyaSgpIHx8IHRoaXMuaXNXZWJDb250ZXh0KCk7XG4gIH1cblxuICB2YWxpZGF0ZUxvY2F0b3JTdHJhdGVneSAoc3RyYXRlZ3kpIHtcbiAgICBzdXBlci52YWxpZGF0ZUxvY2F0b3JTdHJhdGVneShzdHJhdGVneSwgdGhpcy5pc1dlYkNvbnRleHQoKSk7XG4gIH1cblxuICB2YWxpZGF0ZURlc2lyZWRDYXBzIChjYXBzKSB7XG4gICAgLy8gY2hlY2sgd2l0aCB0aGUgYmFzZSBjbGFzcywgYW5kIHJldHVybiBpZiBpdCBmYWlsc1xuICAgIGxldCByZXMgPSBzdXBlci52YWxpZGF0ZURlc2lyZWRDYXBzKGNhcHMpO1xuICAgIGlmICghcmVzKSByZXR1cm4gcmVzO1xuXG4gICAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIGNhcGFiaWxpdGllcyBoYXZlIG9uZSBvZiBgYXBwYCBvciBgYnVuZGxlSWRgXG4gICAgaWYgKChjYXBzLmJyb3dzZXJOYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpICE9PSAnc2FmYXJpJyAmJlxuICAgICAgICAhY2Fwcy5hcHAgJiYgISBjYXBzLmJ1bmRsZUlkKSB7XG4gICAgICBsZXQgbXNnID0gJ1RoZSBkZXNpcmVkIGNhcGFiaWxpdGllcyBtdXN0IGluY2x1ZGUgZWl0aGVyIGFuIGFwcCBvciBhIGJ1bmRsZUlkIGZvciBpT1MnO1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3cobXNnKTtcbiAgICB9XG5cbiAgICBsZXQgdmVyaWZ5UHJvY2Vzc0FyZ3VtZW50ID0gKHByb2Nlc3NBcmd1bWVudHMpID0+IHtcbiAgICAgIGlmICghXy5pc05pbChwcm9jZXNzQXJndW1lbnRzLmFyZ3MpICYmICFfLmlzQXJyYXkocHJvY2Vzc0FyZ3VtZW50cy5hcmdzKSkge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdygncHJvY2Vzc0FyZ3VtZW50cy5hcmdzIG11c3QgYmUgYW4gYXJyYXkgb2Ygc3RyaW5nJyk7XG4gICAgICB9XG5cbiAgICAgIGlmICghXy5pc05pbChwcm9jZXNzQXJndW1lbnRzLmVudikgJiYgIV8uaXNPYmplY3QoY2Fwcy5wcm9jZXNzQXJndW1lbnRzLmVudikpIHtcbiAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ3Byb2Nlc3NBcmd1bWVudHMuZW52IG11c3QgYmUgYW4gb2JqZWN0IDxrZXksdmFsdWU+IHBhaXIge2E6YiwgYzpkfScpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICAvLyBgcHJvY2Vzc0FyZ3VtZW50c2Agc2hvdWxkIGJlIEpTT04gc3RyaW5nIG9yIGFuIG9iamVjdCB3aXRoIGFyZ3VtZW50cyBhbmQvIGVudmlyb25tZW50IGRldGFpbHNcbiAgICBpZiAoY2Fwcy5wcm9jZXNzQXJndW1lbnRzKSB7XG4gICAgICBpZiAoXy5pc1N0cmluZyhjYXBzLnByb2Nlc3NBcmd1bWVudHMpKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gdHJ5IHRvIHBhcnNlIHRoZSBzdHJpbmcgYXMgSlNPTlxuICAgICAgICAgIGNhcHMucHJvY2Vzc0FyZ3VtZW50cyA9IEpTT04ucGFyc2UoY2Fwcy5wcm9jZXNzQXJndW1lbnRzKTtcbiAgICAgICAgICB2ZXJpZnlQcm9jZXNzQXJndW1lbnQoY2Fwcy5wcm9jZXNzQXJndW1lbnRzKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLmVycm9yQW5kVGhyb3coYHByb2Nlc3NBcmd1bWVudHMgbXVzdCBiZSBhIGpzb24gZm9ybWF0IG9yIGFuIG9iamVjdCB3aXRoIGZvcm1hdCB7YXJndW1lbnRzIDogW10sIGVudmlyb25tZW50IDoge2E6YiwgYzpkfX0uIEJvdGggZW52aXJvbm1lbnQgYW5kIGFyZ3VtZW50IGNhbiBiZSBudWxsLiBFcnJvciA6ICR7ZXJyfWApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKF8uaXNPYmplY3QoY2Fwcy5wcm9jZXNzQXJndW1lbnRzKSkge1xuICAgICAgICB2ZXJpZnlQcm9jZXNzQXJndW1lbnQoY2Fwcy5wcm9jZXNzQXJndW1lbnRzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KCdwcm9jZXNzQXJndW1lbnRzIG11c3QgYmUgYW4gb2JqZWN0LCBvciBhIHN0cmluZyBKU09OIG9iamVjdCB3aXRoIGZvcm1hdCB7YXJndW1lbnRzIDogW10sIGVudmlyb25tZW50IDoge2E6YiwgYzpkfX0uIEJvdGggZW52aXJvbm1lbnQgYW5kIGFyZ3VtZW50IGNhbiBiZSBudWxsLicpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIHRoZXJlIGlzIG5vIHBvaW50IGluIGhhdmluZyBga2V5Y2hhaW5QYXRoYCB3aXRob3V0IGBrZXljaGFpblBhc3N3b3JkYFxuICAgIGlmICgoY2Fwcy5rZXljaGFpblBhdGggJiYgIWNhcHMua2V5Y2hhaW5QYXNzd29yZCkgfHwgKCFjYXBzLmtleWNoYWluUGF0aCAmJiBjYXBzLmtleWNoYWluUGFzc3dvcmQpKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgSWYgJ2tleWNoYWluUGF0aCcgaXMgc2V0LCAna2V5Y2hhaW5QYXNzd29yZCcgbXVzdCBhbHNvIGJlIHNldCAoYW5kIHZpY2UgdmVyc2EpLmApO1xuICAgIH1cblxuICAgIC8vIGZpbmFsbHksIHJldHVybiB0cnVlIHNpbmNlIHRoZSBzdXBlcmNsYXNzIGNoZWNrIHBhc3NlZCwgYXMgZGlkIHRoaXNcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxBcHAgKCkge1xuICAgIGlmICh0aGlzLmlzU2FmYXJpKCkpe1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyBpZiB1c2VyIGhhcyBwYXNzZWQgaW4gZGVzaXJlZENhcHMuYXV0b0xhdW5jaCA9IGZhbHNlXG4gICAgLy8gbWVhbmluZyB0aGV5IHdpbGwgbWFuYWdlIGFwcCBpbnN0YWxsIC8gbGF1bmNoaW5nXG4gICAgaWYgKHRoaXMub3B0cy5hdXRvTGF1bmNoID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICBhd2FpdCB0aGlzLmluc3RhbGxUb1JlYWxEZXZpY2UoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5pbnN0YWxsVG9TaW11bGF0b3IoKTtcbiAgICB9XG5cbiAgICBpZiAodXRpbC5oYXNWYWx1ZSh0aGlzLm9wdHMuaW9zSW5zdGFsbFBhdXNlKSkge1xuICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vaXNzdWVzLzY4ODlcbiAgICAgIGxldCBwYXVzZSA9IHBhcnNlSW50KHRoaXMub3B0cy5pb3NJbnN0YWxsUGF1c2UsIDEwKTtcbiAgICAgIGF3YWl0IEIuZGVsYXkocGF1c2UpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxUb1NpbXVsYXRvciAoKSB7XG4gICAgaWYgKHRoaXMub3B0cy5mdWxsUmVzZXQgJiYgdGhpcy5vcHRzLmJ1bmRsZUlkKSB7XG4gICAgICBsb2cuZGVidWcoJ0Z1bGwgcmVzZXQgcmVxdWVzdGVkLiBSZW1vdmluZyBhcHAgZnJvbSBkZXZpY2UnKTtcbiAgICAgIGF3YWl0IHJlbW92ZUFwcCh0aGlzLm9wdHMuZGV2aWNlLnVkaWQsIHRoaXMub3B0cy5idW5kbGVJZCk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgSW5zdGFsbGluZyBhcHAgJyR7dGhpcy5vcHRzLmFwcH0nIG9uIGRldmljZWApO1xuICAgIGF3YWl0IGluc3RhbGxBcHAodGhpcy5vcHRzLmRldmljZS51ZGlkLCB0aGlzLm9wdHMuYXBwKTtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxUb1JlYWxEZXZpY2UgKCkge1xuICAgIGlmICh0aGlzLm9wdHMudWRpZCkge1xuICAgICAgaWYgKGF3YWl0IHRoaXMub3B0cy5kZXZpY2UuaXNJbnN0YWxsZWQodGhpcy5vcHRzLmJ1bmRsZUlkKSkge1xuICAgICAgICBsb2cuZGVidWcoXCJBcHAgaXMgaW5zdGFsbGVkLlwiKTtcbiAgICAgICAgaWYgKHRoaXMub3B0cy5mdWxsUmVzZXQpIHtcbiAgICAgICAgICBsb2cuZGVidWcoJ0Z1bGwgcmVzZXQgcmVxdWVzdGVkLiBGb3JjaW5nIGFwcCBpbnN0YWxsIGFmdGVyIHVuaW5zdGFsbCBhcHAnKTtcbiAgICAgICAgICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLnJlbW92ZSh0aGlzLm9wdHMuYnVuZGxlSWQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxvZy5kZWJ1ZygnRnVsbCByZXNldCBub3QgcmVxdWVzdGVkLiBObyBuZWVkIHRvIGluc3RhbGwuJyk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoJ0FwcCBpcyBub3QgaW5zdGFsbGVkLiBXaWxsIHRyeSB0byBpbnN0YWxsLicpO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5vcHRzLmFwcCkge1xuICAgICAgICBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmluc3RhbGwodGhpcy5vcHRzLmFwcCk7XG4gICAgICAgIGxvZy5kZWJ1ZygnQXBwIGluc3RhbGxlZC4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhcIlJlYWwgZGV2aWNlIHNwZWNpZmllZCBidXQgbm8gaXBhIG9yIGFwcCBwYXRoLCBhc3N1bWluZyBidW5kbGUgSUQgaXMgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgXCJvbiBkZXZpY2VcIik7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhcIk5vIGRldmljZSBpZCBvciBhcHAsIG5vdCBpbnN0YWxsaW5nIHRvIHJlYWwgZGV2aWNlLlwiKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXRJRGV2aWNlT2JqICgpIHtcbiAgICBsb2cuZGVidWcoYENyZWF0aW5nIGlEZXZpY2Ugb2JqZWN0IHdpdGggdWRpZCAke3RoaXMub3B0cy51ZGlkfWApO1xuICAgIHRyeSB7XG4gICAgICAvL1RoaXMgaURldmljZSBvYmplY3QgY291bGQgYmUgaWRldmljZWluc3RhbGxlciAobm9kZS1pZGV2aWNlKSBmb3IgZnV0dXJlIG9uY2Ugd2UgaGF2ZSBpZGV2aWNlaW5zdGFsbGVyIHdvcmtpbmcgZm9yIGlvcyAxMFxuICAgICAgbGV0IGlEZXZpY2UgPSBuZXcgSU9TRGVwbG95KHRoaXMub3B0cy51ZGlkKTtcbiAgICAgIGF3YWl0IGlEZXZpY2UuY2hlY2tTdGF0dXMoKTtcbiAgICAgIHJldHVybiBpRGV2aWNlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxldCBtc2cgPSBcIkNvdWxkIG5vdCBpbml0aWFsaXplIGlvcy1kZXBsb3kgbWFrZSBzdXJlIGl0IGlzIFwiICtcbiAgICAgICAgICAgICAgICBcImluc3RhbGxlZCBhbmQgd29ya3Mgb24geW91ciBzeXN0ZW1cIjtcbiAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2V0SW5pdGlhbE9yaWVudGF0aW9uIChvcmllbnRhdGlvbikge1xuICAgIGlmICh0eXBlb2Ygb3JpZW50YXRpb24gPT09ICdzdHJpbmcnKSB7XG4gICAgICBvcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uLnRvVXBwZXJDYXNlKCk7XG4gICAgICBpZiAoIV8uaW5jbHVkZXMoWydMQU5EU0NBUEUnLCAnUE9SVFJBSVQnXSwgb3JpZW50YXRpb24pKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgVW5hYmxlIHRvIHNldCBpbml0aWFsIG9yaWVudGF0aW9uIHRvICcke29yaWVudGF0aW9ufSdgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGBTZXR0aW5nIGluaXRpYWwgb3JpZW50YXRpb24gdG8gJyR7b3JpZW50YXRpb259J2ApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9vcmllbnRhdGlvbicsICdQT1NUJywge29yaWVudGF0aW9ufSk7XG4gICAgICAgIHRoaXMub3B0cy5jdXJPcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZy53YXJuKGBTZXR0aW5nIGluaXRpYWwgb3JpZW50YXRpb24gZmFpbGVkIHdpdGg6ICR7ZXJyfWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mb3IgKGxldCBbY21kLCBmbl0gb2YgXy50b1BhaXJzKGNvbW1hbmRzKSkge1xuICBYQ1VJVGVzdERyaXZlci5wcm90b3R5cGVbY21kXSA9IGZuO1xufVxuXG5cbmV4cG9ydCBkZWZhdWx0IFhDVUlUZXN0RHJpdmVyO1xuZXhwb3J0IHsgWENVSVRlc3REcml2ZXIgfTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
