'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _teen_process = require('teen_process');

var _appiumBaseDriver = require('appium-base-driver');

var _appiumSupport = require('appium-support');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumLogger = require('appium-logger');

var _simulatorManagementJs = require('./simulator-management.js');

var agentLog = (0, _appiumLogger.getLogger)('WebDriverAgent');
var xcodeLog = (0, _appiumLogger.getLogger)('Xcode');
var iproxyLog = (0, _appiumLogger.getLogger)('iProxy');

var AGENT_PATH = _path2['default'].resolve(__dirname, '..', '..', 'WebDriverAgent', 'WebDriverAgent.xcodeproj');
var BOOTSTRAP_PATH = _path2['default'].resolve(__dirname, '..', '..', 'WebDriverAgent');
var AGENT_LOG_PREFIX = 'XCTStubApps[';
var AGENT_RUNNER_LOG_PREFIX = 'XCTRunner[';
var SIM_BRIDGE_LOG_PREFIX = 'CoreSimulatorBridge[';
var AGENT_STARTED_REGEX = /ServerURLHere->(.*)<-ServerURLHere/;
var LOG_STARTTIME_REGEX = /Built at (\w{3} [\d\s]\d \d{4} \d{2}:\d{2}:\d{2})/;
var REAL_DEVICE_LOGGER_PATH = 'idevicesyslog';

var WebDriverAgent = (function () {

  // agentPath (optional): Path to WebdriverAgent Executable (inside WebDriverAgent.app)

  function WebDriverAgent() {
    var args = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, WebDriverAgent);

    if (args.agentPath) {
      _logger2['default'].info('Custom agent path specified: ' + args.agentPath);
    } else {
      _logger2['default'].info('Using default agent: ' + AGENT_PATH);
    }

    if (args.bootstrapPath) {
      _logger2['default'].info('Custom bootstrap path specified: ' + args.bootstrapPath);
    } else {
      _logger2['default'].info('Using default bootstrap: ' + BOOTSTRAP_PATH);
    }

    this.device = args.device;
    this.platformVersion = args.platformVersion;
    this.host = args.host;
    this.realDevice = !!args.realDevice;

    this.agentPath = args.agentPath || AGENT_PATH;
    this.bootstrapPath = args.bootstrapPath || BOOTSTRAP_PATH;
    this.realDeviceLogger = args.realDeviceLogger || REAL_DEVICE_LOGGER_PATH;
    this.wdaLocalPort = args.wdaLocalPort;
    this.iosLogAlreadyShown = args.showIOSLog;
    this.showXcodeLog = !!args.showXcodeLog;
    this.xcodeConfigFile = args.xcodeConfigFile;
    this.keychainPath = args.keychainPath;
    this.keychainPassword = args.keychainPassword;
    this.webDriverAgentUrl = args.webDriverAgentUrl;
  }

  _createClass(WebDriverAgent, [{
    key: 'launch',
    value: function launch(sessionId) {
      var agentUrl, localport;
      return _regeneratorRuntime.async(function launch$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.webDriverAgentUrl) {
              context$2$0.next = 5;
              break;
            }

            _logger2['default'].info('Using provided WebdriverAgent at \'' + this.webDriverAgentUrl + '\'');
            this.url = _url2['default'].parse(this.webDriverAgentUrl);
            this.setupProxy(sessionId);
            return context$2$0.abrupt('return', this.webDriverAgentUrl);

          case 5:

            _logger2['default'].info('Launching WebDriverAgent on the device');

            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.agentPath));

          case 8:
            if (context$2$0.sent) {
              context$2$0.next = 10;
              break;
            }

            throw new Error('Trying to use WebDriverAgent project at \'' + this.agentPath + '\' but the ' + 'file does not exist');

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.destroyXcodeProcesses());

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.checkForDependencies());

          case 14:
            if (!this.realDevice) {
              context$2$0.next = 20;
              break;
            }

            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(this.createRealDeviceLogsSubProcess());

          case 17:
            this.deviceLogs = context$2$0.sent;
            context$2$0.next = 23;
            break;

          case 20:
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(this.createSimLogsSubProcess());

          case 22:
            this.deviceLogs = context$2$0.sent;

          case 23:
            context$2$0.next = 25;
            return _regeneratorRuntime.awrap(this.createXcodeBuildSubProcess());

          case 25:
            this.xcodebuild = context$2$0.sent;
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(this.startXcodebuild());

          case 28:
            agentUrl = context$2$0.sent;

            this.url = _url2['default'].parse(agentUrl);

            this.url.hostname = 'localhost';

            if (!this.realDevice) {
              context$2$0.next = 37;
              break;
            }

            localport = this.wdaLocalPort || this.url.port;

            this.iproxy = this.createiProxySubProcess(localport, this.url.port);
            context$2$0.next = 36;
            return _regeneratorRuntime.awrap(this.startiproxy());

          case 36:
            this.url.port = localport;

          case 37:

            this.setupProxy(sessionId);

            return context$2$0.abrupt('return', agentUrl);

          case 39:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setupProxy',
    value: function setupProxy(sessionId) {
      this.jwproxy = new _appiumBaseDriver.JWProxy({ server: this.url.hostname, port: this.url.port, base: '' });
      this.jwproxy.sessionId = sessionId;
      this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    }
  }, {
    key: 'destroyXcodeProcesses',
    value: function destroyXcodeProcesses() {
      var _ref, stdout, match;

      return _regeneratorRuntime.async(function destroyXcodeProcesses$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('ps', ['-ax']));

          case 3:
            _ref = context$2$0.sent;
            stdout = _ref.stdout;
            match = /(\d+)\s.+?(?=xcodebuild)/.exec(stdout);

            if (match) {
              _logger2['default'].info('killing xcodebuild process: ' + match[1]);
              process.kill(match[1]);
            }
            context$2$0.next = 12;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t0 = context$2$0['catch'](0);

            _logger2['default'].error('Could not get xcodebuild processes: ' + context$2$0.t0);

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 9]]);
    }
  }, {
    key: 'checkForDependencies',
    value: function checkForDependencies() {
      var carthagePath;
      return _regeneratorRuntime.async(function checkForDependencies$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.which('carthage'));

          case 3:
            carthagePath = context$2$0.sent;

            _logger2['default'].debug('Carthage found: ' + carthagePath);
            context$2$0.next = 10;
            break;

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](0);

            _logger2['default'].info('Carthage not found. Install using `brew install carthage`');

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Carthage'));

          case 12:
            if (context$2$0.sent) {
              context$2$0.next = 16;
              break;
            }

            _logger2['default'].debug('Running WebDriverAgent bootstrap script to install dependencies');
            context$2$0.next = 16;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('/bin/bash', ['Scripts/bootstrap.sh', '-d'], { cwd: this.bootstrapPath }));

          case 16:
            context$2$0.next = 18;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Resources'));

          case 18:
            if (context$2$0.sent) {
              context$2$0.next = 22;
              break;
            }

            _logger2['default'].debug('Creating WebDriverAgent resources directory');
            context$2$0.next = 22;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(this.bootstrapPath + '/Resources'));

          case 22:
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.hasAccess(this.bootstrapPath + '/Resources/WebDriverAgent.bundle'));

          case 24:
            if (context$2$0.sent) {
              context$2$0.next = 28;
              break;
            }

            _logger2['default'].debug('Creating WebDriverAgent resource bundle directory');
            context$2$0.next = 28;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(this.bootstrapPath + '/Resources/WebDriverAgent.bundle'));

          case 28:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 7]]);
    }
  }, {
    key: 'createXcodeBuildSubProcess',
    value: function createXcodeBuildSubProcess() {
      var cmd, args, xcodebuild, logXcodeOutput;
      return _regeneratorRuntime.async(function createXcodeBuildSubProcess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmd = 'xcodebuild';
            args = ['build', 'test', '-project', this.agentPath, '-scheme', 'WebDriverAgentRunner', '-destination', 'id=' + this.device.udid, '-configuration', 'Debug'];

            if (this.realDevice) {
              cmd = _path2['default'].resolve(__dirname, '..', '..', 'bin', 'run-xcodebuild.sh');
              args = ['--project', this.agentPath, '--scheme', 'WebDriverAgentRunner', '--destination', 'id=' + this.device.udid];
              if (this.xcodeConfigFile) {
                _logger2['default'].debug('Using Xcode configuration file: \'' + this.xcodeConfigFile + '\'');
                args.push('--xcode-config-file', '"' + this.xcodeConfigFile + '"');
              }
              if (this.keychainPath && this.keychainPassword) {
                args.push('--keychain-path', this.keychainPath);
                args.push('--keychain-password', this.keychainPassword);
              }
            }

            _logger2['default'].debug('Beginning test with command \'' + cmd + ' ' + args.join(' ') + '\' ' + ('in directory \'' + this.bootstrapPath + '\''));
            xcodebuild = new _teen_process.SubProcess(cmd, args, { cwd: this.bootstrapPath });
            logXcodeOutput = this.showXcodeLog;

            xcodebuild.on('output', function (stdout, stderr) {
              var out = stdout || stderr;
              // we want to pull out the log file that is created, and highlight it
              // for diagnostic purposes
              if (out.indexOf('Writing diagnostic log for test session to') !== -1) {
                // pull out the first line that begins with the path separator
                // which *should* be the line indicating the log file generated
                var logLocation = _lodash2['default'].first(_lodash2['default'].remove(out.trim().split('\n'), function (v) {
                  return v.indexOf(_path2['default'].sep) === 0;
                }));
                _logger2['default'].debug('Log file for xcodebuild test: ' + logLocation);
              }

              // if we have an error we want to output the logs
              // otherwise the failure is inscrutible
              if (out.indexOf('Error Domain=') !== -1) {
                logXcodeOutput = true;
              }

              if (logXcodeOutput) {
                xcodeLog.info(out);
              }
            });

            return context$2$0.abrupt('return', xcodebuild);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createSimLogsSubProcess',
    value: function createSimLogsSubProcess() {
      var args, logs;
      return _regeneratorRuntime.async(function createSimLogsSubProcess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = ['-f', '-n', '0', _path2['default'].resolve(this.device.getLogDir(), 'system.log')];
            logs = new _teen_process.SubProcess('tail', args);

            this.setupLogging(logs, 'Sim');
            return context$2$0.abrupt('return', logs);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'createiProxySubProcess',
    value: function createiProxySubProcess(localport, deviceport) {
      _logger2['default'].debug('Starting iproxy to forward traffic from local port ' + localport + ' to device port ' + deviceport + ' over USB');
      return new _teen_process.SubProcess('iproxy', [localport, deviceport, this.device.udid]);
    }
  }, {
    key: 'createRealDeviceLogsSubProcess',
    value: function createRealDeviceLogsSubProcess() {
      var checkForLogger, logs;
      return _regeneratorRuntime.async(function createRealDeviceLogsSubProcess$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            checkForLogger = function checkForLogger(logger) {
              return _regeneratorRuntime.async(function checkForLogger$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.which(logger));

                  case 3:
                    context$3$0.next = 10;
                    break;

                  case 5:
                    context$3$0.prev = 5;
                    context$3$0.t0 = context$3$0['catch'](0);
                    context$3$0.next = 9;
                    return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(logger));

                  case 9:
                    return context$3$0.abrupt('return', context$3$0.sent);

                  case 10:
                    return context$3$0.abrupt('return', true);

                  case 11:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, this, [[0, 5]]);
            };

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(checkForLogger(this.realDeviceLogger));

          case 3:
            if (context$2$0.sent) {
              context$2$0.next = 5;
              break;
            }

            throw new Error('Unable to find real device logging program \'' + this.realDeviceLogger + '\'');

          case 5:
            logs = new _teen_process.SubProcess('' + this.realDeviceLogger, ['-u', this.device.udid]);

            this.setupLogging(logs, 'Device');
            return context$2$0.abrupt('return', logs);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'setupLogging',
    value: function setupLogging(logs, prefix) {
      var _this = this;

      var loggingStarted = !this.realDevice;
      var startTime = new Date();
      function shouldStartLogging(row) {
        var logRowParts = row.split(/\s+/);
        var logRowDate = new Date(startTime.getFullYear() + ' ' + logRowParts[0] + ' ' + logRowParts[1] + ' ' + logRowParts[2]);
        loggingStarted = logRowDate.isAfter(startTime);
        return loggingStarted;
      }

      function isPertinentLogLine(line) {
        return line.length && (line.indexOf(AGENT_LOG_PREFIX) !== -1 || line.indexOf(AGENT_RUNNER_LOG_PREFIX) !== -1 || line.indexOf(SIM_BRIDGE_LOG_PREFIX) !== -1);
      }

      if (this.realDevice && this.realDeviceLogger.indexOf('idevicesyslog') !== -1) {
        // we are using idevicesyslog, which sometimes cannot connect to the device
        // at which time the system will not be able to figure out that the process
        // has started
        logs.on('output', function (stdout, stderr) {
          var errorString = 'Could not start logger for udid';
          if (stdout.indexOf(errorString) !== -1 || stderr.indexOf(errorString) !== -1) {
            // unfortunately we have no way to stopping the process, so just log overtly
            var msg = 'The real device logger \'' + _this.realDeviceLogger + '\' was ' + 'unable to start log capture. Please try installing ' + '\'deviceconsole\' (\'npm install -g deviceconsole\') and ' + 'specify the path to it using the \'realDeviceLogger\' capability.';
            _logger2['default'].error(msg);
          }
        });
      }

      if (!this.iosLogAlreadyShown) {
        logs.on('output', function (stdout, stderr) {
          var out = stdout || stderr;
          // make sure we are not reading logs from before this test run
          if (!loggingStarted && !shouldStartLogging(out)) {
            return;
          }
          if (isPertinentLogLine(out)) {
            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
              for (var _iterator = _getIterator(out.split("\n").filter(Boolean)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                var line = _step.value;

                agentLog.debug(prefix + ': ' + line);
              }
            } catch (err) {
              _didIteratorError = true;
              _iteratorError = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion && _iterator['return']) {
                  _iterator['return']();
                }
              } finally {
                if (_didIteratorError) {
                  throw _iteratorError;
                }
              }
            }
          }
        });
      }
    }
  }, {
    key: 'startXcodebuild',
    value: function startXcodebuild() {
      return _regeneratorRuntime.async(function startXcodebuild$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function callee$2$0(resolve, reject) {
              var startTime, agentUrl, msg;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this2 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    this.xcodebuild.on('exit', function (code, signal) {
                      _logger2['default'].info('xcodebuild exited with code \'' + code + '\' and signal \'' + signal + '\'');
                      if (!signal && code !== 0) {
                        return reject(new Error('xcodebuild failed with code ' + code));
                      }
                    });

                    this.deviceLogs.on('exit', function (code) {
                      var msg = (_this2.realDevice ? 'System' : 'Simulator') + ' log exited with code \'' + code + '\'';
                      _logger2['default'].info(msg);
                      if (code) {
                        return reject(msg);
                      }
                    });

                    context$3$0.prev = 2;
                    startTime = new Date();
                    context$3$0.next = 6;
                    return _regeneratorRuntime.awrap(this.xcodebuild.start());

                  case 6:
                    context$3$0.next = 8;
                    return _regeneratorRuntime.awrap(this.waitForStart(startTime));

                  case 8:
                    agentUrl = context$3$0.sent;

                    resolve(agentUrl);
                    context$3$0.next = 17;
                    break;

                  case 12:
                    context$3$0.prev = 12;
                    context$3$0.t0 = context$3$0['catch'](2);
                    msg = 'Unable to start WebDriverAgent: ' + context$3$0.t0;

                    _logger2['default'].error(msg);
                    return context$3$0.abrupt('return', reject(msg));

                  case 17:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3, [[2, 12]]);
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForStart',
    value: function waitForStart(startTime) {
      var agentUrl, lineCount, reachedEnd, startDetector;
      return _regeneratorRuntime.async(function waitForStart$(context$2$0) {
        var _this4 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.realDevice) {
              context$2$0.next = 3;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _simulatorManagementJs.systemLogExists)(this.device));

          case 3:
            agentUrl = undefined;
            lineCount = 0;
            reachedEnd = !this.realDevice;

            startDetector = function startDetector(stdout) {
              // on a real device there may already be system logs that need to be
              // passed before we get to the real startup logs, otherwise
              // we expect two lines, one after another
              //     Jul 20 13:03:57 iamPhone XCTRunner[296] <Warning>: Built at Jul 20 2016 13:03:50
              //     Jul 20 13:03:57 iamPhone XCTRunner[296] <Warning>: ServerURLHere->http://10.35.4.122:8100<-ServerURLHere
              if (!reachedEnd) {
                var dateMatch = LOG_STARTTIME_REGEX.exec(stdout);
                if (dateMatch) {
                  var buildTime = new Date(dateMatch[1]);
                  if (buildTime.isAfter(startTime)) {
                    reachedEnd = true;
                  }
                }
              }

              if (reachedEnd) {
                var match = AGENT_STARTED_REGEX.exec(stdout);
                if (match) {
                  agentUrl = match[1];
                  _logger2['default'].info('Detected that WebDriverAgent is running at url \'' + agentUrl + '\'');
                  if (!agentUrl) {
                    _logger2['default'].errorAndThrow(new Error('No url detected from WebDriverAgent'));
                  }
                  return true;
                }
              }

              // periodically log, so it does not look like everything died
              lineCount++;
              var threshold = _this4.realDevice ? 1000 : 200;
              if (lineCount % threshold === 0) {
                _logger2['default'].debug('Waiting for WebDriverAgent server to finish loading...');
              }

              return false;
            };

            _logger2['default'].info('Waiting for WebDriverAgent to start on device');
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.deviceLogs.start(startDetector));

          case 10:
            _logger2['default'].info('WebDriverAgent started at url \'' + agentUrl + '\'');

            return context$2$0.abrupt('return', agentUrl);

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startiproxy',
    value: function startiproxy() {
      return _regeneratorRuntime.async(function startiproxy$(context$2$0) {
        var _this5 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function callee$2$0(resolve, reject) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    this.iproxy.on('exit', function (code) {
                      if (code) {
                        return reject(new Error('iproxy exited with code \'' + code + '\''));
                      }
                    });
                    this.iproxy.on('output', function (stdout, stderr) {
                      var out = stdout || stderr;
                      var _iteratorNormalCompletion2 = true;
                      var _didIteratorError2 = false;
                      var _iteratorError2 = undefined;

                      try {
                        for (var _iterator2 = _getIterator(out.split('\n')), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                          var line = _step2.value;

                          if (!line.length) continue;
                          iproxyLog.debug(line);
                        }
                      } catch (err) {
                        _didIteratorError2 = true;
                        _iteratorError2 = err;
                      } finally {
                        try {
                          if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                            _iterator2['return']();
                          }
                        } finally {
                          if (_didIteratorError2) {
                            throw _iteratorError2;
                          }
                        }
                      }
                    });

                    context$3$0.next = 4;
                    return _regeneratorRuntime.awrap(this.iproxy.start(2000));

                  case 4:
                    resolve();

                  case 5:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this5);
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'quit',
    value: function quit() {
      var getStopPromises;
      return _regeneratorRuntime.async(function quit$(context$2$0) {
        var _this6 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Shutting down WebDriverAgent');

            getStopPromises = function getStopPromises(signal) {
              var stops = [];
              if (_this6.xcodebuild && _this6.xcodebuild.proc) {
                stops.push(_this6.xcodebuild.stop(signal));
              }
              if (_this6.deviceLogs && _this6.deviceLogs.proc) {
                stops.push(_this6.deviceLogs.stop(signal));
              }
              if (_this6.iproxy && _this6.iproxy.proc) {
                stops.push(_this6.iproxy.stop(signal));
              }
              return stops;
            };

            if (this.jwproxy) {
              this.jwproxy.sessionId = null;
            }

            context$2$0.prev = 3;
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_bluebird2['default'].all(getStopPromises()));

          case 6:
            context$2$0.next = 15;
            break;

          case 8:
            context$2$0.prev = 8;
            context$2$0.t0 = context$2$0['catch'](3);

            if (!(context$2$0.t0.message.indexOf('Process didn\'t end after') === -1)) {
              context$2$0.next = 12;
              break;
            }

            throw context$2$0.t0;

          case 12:
            _logger2['default'].debug('WebDriverAgent process did not end in a timely fashion. ' + 'Sending SIGHUP signal...');
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(_bluebird2['default'].all(getStopPromises('SIGHUP')));

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[3, 8]]);
    }
  }]);

  return WebDriverAgent;
})();

exports['default'] = WebDriverAgent;
module.exports = exports['default'];

// ensure there are no dangling xcode processes before building a new one.

// make sure that the WDA library has been built

// start the logging process

// start the xcodebuild process

// the logger can be the name of a program on the PATH
// or a path to the program

// not on the PATH, so see if it is an accessible path itself

// no error thrown, so all is well

// we have no logger

// wrap the start procedure in a promise so that we can catch, and report,
// any startup errors that are thrown as events

// we have to wait for the sim to start before we can tail the log file
// simulator does not need to wait, since we are tailing
//# sourceMappingURL=data:application/json;charset=utf8;base64,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LENBQUE7Ozs7Ozs7O0FBRzNELGdDQUFJLEtBQUssQ0FBQywwREFBMEQsR0FDMUQsMEJBQTBCLENBQUMsQ0FBQzs7NkNBQ2hDLHNCQUFFLEdBQUcsQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7Ozs7Ozs7S0FFekM7OztTQXRaRyxjQUFjOzs7cUJBeVpMLGNBQWMiLCJmaWxlIjoibGliL3dlYmRyaXZlcmFnZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgU3ViUHJvY2VzcywgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBnZXRMb2dnZXIgfSBmcm9tICdhcHBpdW0tbG9nZ2VyJztcbmltcG9ydCB7IHN5c3RlbUxvZ0V4aXN0cyB9IGZyb20gJy4vc2ltdWxhdG9yLW1hbmFnZW1lbnQuanMnO1xuXG5cbmNvbnN0IGFnZW50TG9nID0gZ2V0TG9nZ2VyKCdXZWJEcml2ZXJBZ2VudCcpO1xuY29uc3QgeGNvZGVMb2cgPSBnZXRMb2dnZXIoJ1hjb2RlJyk7XG5jb25zdCBpcHJveHlMb2cgPSBnZXRMb2dnZXIoJ2lQcm94eScpO1xuXG5jb25zdCBBR0VOVF9QQVRIID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ1dlYkRyaXZlckFnZW50JywgJ1dlYkRyaXZlckFnZW50Lnhjb2RlcHJvaicpO1xuY29uc3QgQk9PVFNUUkFQX1BBVEggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnV2ViRHJpdmVyQWdlbnQnKTtcbmNvbnN0IEFHRU5UX0xPR19QUkVGSVggPSAnWENUU3R1YkFwcHNbJztcbmNvbnN0IEFHRU5UX1JVTk5FUl9MT0dfUFJFRklYID0gJ1hDVFJ1bm5lclsnO1xuY29uc3QgU0lNX0JSSURHRV9MT0dfUFJFRklYID0gJ0NvcmVTaW11bGF0b3JCcmlkZ2VbJztcbmNvbnN0IEFHRU5UX1NUQVJURURfUkVHRVggPSAvU2VydmVyVVJMSGVyZS0+KC4qKTwtU2VydmVyVVJMSGVyZS87XG5jb25zdCBMT0dfU1RBUlRUSU1FX1JFR0VYID0gL0J1aWx0IGF0IChcXHd7M30gW1xcZFxcc11cXGQgXFxkezR9IFxcZHsyfTpcXGR7Mn06XFxkezJ9KS87XG5jb25zdCBSRUFMX0RFVklDRV9MT0dHRVJfUEFUSCA9ICdpZGV2aWNlc3lzbG9nJztcblxuY2xhc3MgV2ViRHJpdmVyQWdlbnQge1xuXG4gIC8vIGFnZW50UGF0aCAob3B0aW9uYWwpOiBQYXRoIHRvIFdlYmRyaXZlckFnZW50IEV4ZWN1dGFibGUgKGluc2lkZSBXZWJEcml2ZXJBZ2VudC5hcHApXG4gIGNvbnN0cnVjdG9yIChhcmdzID0ge30pIHtcbiAgICBpZiAoYXJncy5hZ2VudFBhdGgpIHtcbiAgICAgIGxvZy5pbmZvKGBDdXN0b20gYWdlbnQgcGF0aCBzcGVjaWZpZWQ6ICR7YXJncy5hZ2VudFBhdGh9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5pbmZvKGBVc2luZyBkZWZhdWx0IGFnZW50OiAke0FHRU5UX1BBVEh9YCk7XG4gICAgfVxuXG4gICAgaWYgKGFyZ3MuYm9vdHN0cmFwUGF0aCkge1xuICAgICAgbG9nLmluZm8oYEN1c3RvbSBib290c3RyYXAgcGF0aCBzcGVjaWZpZWQ6ICR7YXJncy5ib290c3RyYXBQYXRofWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuaW5mbyhgVXNpbmcgZGVmYXVsdCBib290c3RyYXA6ICR7Qk9PVFNUUkFQX1BBVEh9YCk7XG4gICAgfVxuXG4gICAgdGhpcy5kZXZpY2UgPSBhcmdzLmRldmljZTtcbiAgICB0aGlzLnBsYXRmb3JtVmVyc2lvbiA9IGFyZ3MucGxhdGZvcm1WZXJzaW9uO1xuICAgIHRoaXMuaG9zdCA9IGFyZ3MuaG9zdDtcbiAgICB0aGlzLnJlYWxEZXZpY2UgPSAhIWFyZ3MucmVhbERldmljZTtcblxuICAgIHRoaXMuYWdlbnRQYXRoID0gYXJncy5hZ2VudFBhdGggfHwgQUdFTlRfUEFUSDtcbiAgICB0aGlzLmJvb3RzdHJhcFBhdGggPSBhcmdzLmJvb3RzdHJhcFBhdGggfHwgQk9PVFNUUkFQX1BBVEg7XG4gICAgdGhpcy5yZWFsRGV2aWNlTG9nZ2VyID0gYXJncy5yZWFsRGV2aWNlTG9nZ2VyIHx8IFJFQUxfREVWSUNFX0xPR0dFUl9QQVRIO1xuICAgIHRoaXMud2RhTG9jYWxQb3J0ID0gYXJncy53ZGFMb2NhbFBvcnQ7XG4gICAgdGhpcy5pb3NMb2dBbHJlYWR5U2hvd24gPSBhcmdzLnNob3dJT1NMb2c7XG4gICAgdGhpcy5zaG93WGNvZGVMb2cgPSAhIWFyZ3Muc2hvd1hjb2RlTG9nO1xuICAgIHRoaXMueGNvZGVDb25maWdGaWxlID0gYXJncy54Y29kZUNvbmZpZ0ZpbGU7XG4gICAgdGhpcy5rZXljaGFpblBhdGggPSBhcmdzLmtleWNoYWluUGF0aDtcbiAgICB0aGlzLmtleWNoYWluUGFzc3dvcmQgPSBhcmdzLmtleWNoYWluUGFzc3dvcmQ7XG4gICAgdGhpcy53ZWJEcml2ZXJBZ2VudFVybCA9IGFyZ3Mud2ViRHJpdmVyQWdlbnRVcmw7XG4gIH1cblxuICBhc3luYyBsYXVuY2ggKHNlc3Npb25JZCkge1xuICAgIGlmICh0aGlzLndlYkRyaXZlckFnZW50VXJsKSB7XG4gICAgICBsb2cuaW5mbyhgVXNpbmcgcHJvdmlkZWQgV2ViZHJpdmVyQWdlbnQgYXQgJyR7dGhpcy53ZWJEcml2ZXJBZ2VudFVybH0nYCk7XG4gICAgICB0aGlzLnVybCA9IHVybC5wYXJzZSh0aGlzLndlYkRyaXZlckFnZW50VXJsKTtcbiAgICAgIHRoaXMuc2V0dXBQcm94eShzZXNzaW9uSWQpO1xuICAgICAgcmV0dXJuIHRoaXMud2ViRHJpdmVyQWdlbnRVcmw7XG4gICAgfVxuXG4gICAgbG9nLmluZm8oJ0xhdW5jaGluZyBXZWJEcml2ZXJBZ2VudCBvbiB0aGUgZGV2aWNlJyk7XG5cbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyh0aGlzLmFnZW50UGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHJ5aW5nIHRvIHVzZSBXZWJEcml2ZXJBZ2VudCBwcm9qZWN0IGF0ICcke3RoaXMuYWdlbnRQYXRofScgYnV0IHRoZSBgICtcbiAgICAgICAgICAgICAgICAgICAgICAnZmlsZSBkb2VzIG5vdCBleGlzdCcpO1xuICAgIH1cbiAgICAvLyBlbnN1cmUgdGhlcmUgYXJlIG5vIGRhbmdsaW5nIHhjb2RlIHByb2Nlc3NlcyBiZWZvcmUgYnVpbGRpbmcgYSBuZXcgb25lLlxuICAgIGF3YWl0IHRoaXMuZGVzdHJveVhjb2RlUHJvY2Vzc2VzKCk7XG5cbiAgICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgV0RBIGxpYnJhcnkgaGFzIGJlZW4gYnVpbHRcbiAgICBhd2FpdCB0aGlzLmNoZWNrRm9yRGVwZW5kZW5jaWVzKCk7XG5cbiAgICAvLyBzdGFydCB0aGUgbG9nZ2luZyBwcm9jZXNzXG4gICAgaWYgKHRoaXMucmVhbERldmljZSkge1xuICAgICAgdGhpcy5kZXZpY2VMb2dzID0gYXdhaXQgdGhpcy5jcmVhdGVSZWFsRGV2aWNlTG9nc1N1YlByb2Nlc3MoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kZXZpY2VMb2dzID0gYXdhaXQgdGhpcy5jcmVhdGVTaW1Mb2dzU3ViUHJvY2VzcygpO1xuICAgIH1cblxuICAgIHRoaXMueGNvZGVidWlsZCA9IGF3YWl0IHRoaXMuY3JlYXRlWGNvZGVCdWlsZFN1YlByb2Nlc3MoKTtcblxuICAgIC8vIHN0YXJ0IHRoZSB4Y29kZWJ1aWxkIHByb2Nlc3NcbiAgICBsZXQgYWdlbnRVcmwgPSBhd2FpdCB0aGlzLnN0YXJ0WGNvZGVidWlsZCgpO1xuXG4gICAgdGhpcy51cmwgPSB1cmwucGFyc2UoYWdlbnRVcmwpO1xuXG4gICAgdGhpcy51cmwuaG9zdG5hbWUgPSAnbG9jYWxob3N0JztcbiAgICBpZiAodGhpcy5yZWFsRGV2aWNlKSB7XG4gICAgICBsZXQgbG9jYWxwb3J0ID0gdGhpcy53ZGFMb2NhbFBvcnQgfHwgdGhpcy51cmwucG9ydDtcbiAgICAgIHRoaXMuaXByb3h5ID0gdGhpcy5jcmVhdGVpUHJveHlTdWJQcm9jZXNzKGxvY2FscG9ydCwgdGhpcy51cmwucG9ydCk7XG4gICAgICBhd2FpdCB0aGlzLnN0YXJ0aXByb3h5KCk7XG4gICAgICB0aGlzLnVybC5wb3J0ID0gbG9jYWxwb3J0O1xuICAgIH1cblxuICAgIHRoaXMuc2V0dXBQcm94eShzZXNzaW9uSWQpO1xuXG4gICAgcmV0dXJuIGFnZW50VXJsO1xuICB9XG5cbiAgc2V0dXBQcm94eSAoc2Vzc2lvbklkKSB7XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe3NlcnZlcjogdGhpcy51cmwuaG9zdG5hbWUsIHBvcnQ6IHRoaXMudXJsLnBvcnQsIGJhc2U6ICcnfSk7XG4gICAgdGhpcy5qd3Byb3h5LnNlc3Npb25JZCA9IHNlc3Npb25JZDtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5qd3Byb3h5KTtcbiAgfVxuXG4gIGFzeW5jIGRlc3Ryb3lYY29kZVByb2Nlc3NlcyAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3BzJywgWyctYXgnXSk7XG4gICAgICBsZXQgbWF0Y2ggPSAvKFxcZCspXFxzLis/KD89eGNvZGVidWlsZCkvLmV4ZWMoc3Rkb3V0KTtcbiAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICBsb2cuaW5mbyhga2lsbGluZyB4Y29kZWJ1aWxkIHByb2Nlc3M6ICR7bWF0Y2hbMV19YCk7XG4gICAgICAgIHByb2Nlc3Mua2lsbChtYXRjaFsxXSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3IoYENvdWxkIG5vdCBnZXQgeGNvZGVidWlsZCBwcm9jZXNzZXM6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNoZWNrRm9yRGVwZW5kZW5jaWVzICgpIHtcbiAgICB0cnkge1xuICAgICAgbGV0IGNhcnRoYWdlUGF0aCA9IGF3YWl0IGZzLndoaWNoKCdjYXJ0aGFnZScpO1xuICAgICAgbG9nLmRlYnVnKGBDYXJ0aGFnZSBmb3VuZDogJHtjYXJ0aGFnZVBhdGh9YCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuaW5mbygnQ2FydGhhZ2Ugbm90IGZvdW5kLiBJbnN0YWxsIHVzaW5nIGBicmV3IGluc3RhbGwgY2FydGhhZ2VgJyk7XG4gICAgfVxuICAgIGlmICghYXdhaXQgZnMuaGFzQWNjZXNzKGAke3RoaXMuYm9vdHN0cmFwUGF0aH0vQ2FydGhhZ2VgKSkge1xuICAgICAgbG9nLmRlYnVnKCdSdW5uaW5nIFdlYkRyaXZlckFnZW50IGJvb3RzdHJhcCBzY3JpcHQgdG8gaW5zdGFsbCBkZXBlbmRlbmNpZXMnKTtcbiAgICAgIGF3YWl0IGV4ZWMoJy9iaW4vYmFzaCcsIFsnU2NyaXB0cy9ib290c3RyYXAuc2gnLCAnLWQnXSwge2N3ZDogdGhpcy5ib290c3RyYXBQYXRofSk7XG4gICAgfVxuICAgIGlmICghYXdhaXQgZnMuaGFzQWNjZXNzKGAke3RoaXMuYm9vdHN0cmFwUGF0aH0vUmVzb3VyY2VzYCkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnQ3JlYXRpbmcgV2ViRHJpdmVyQWdlbnQgcmVzb3VyY2VzIGRpcmVjdG9yeScpO1xuICAgICAgYXdhaXQgZnMubWtkaXIoYCR7dGhpcy5ib290c3RyYXBQYXRofS9SZXNvdXJjZXNgKTtcbiAgICB9XG4gICAgaWYgKCFhd2FpdCBmcy5oYXNBY2Nlc3MoYCR7dGhpcy5ib290c3RyYXBQYXRofS9SZXNvdXJjZXMvV2ViRHJpdmVyQWdlbnQuYnVuZGxlYCkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnQ3JlYXRpbmcgV2ViRHJpdmVyQWdlbnQgcmVzb3VyY2UgYnVuZGxlIGRpcmVjdG9yeScpO1xuICAgICAgYXdhaXQgZnMubWtkaXIoYCR7dGhpcy5ib290c3RyYXBQYXRofS9SZXNvdXJjZXMvV2ViRHJpdmVyQWdlbnQuYnVuZGxlYCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY3JlYXRlWGNvZGVCdWlsZFN1YlByb2Nlc3MgKCkge1xuICAgIGxldCBjbWQgPSAneGNvZGVidWlsZCc7XG4gICAgbGV0IGFyZ3MgPSBbXG4gICAgICAnYnVpbGQnLFxuICAgICAgJ3Rlc3QnLFxuICAgICAgJy1wcm9qZWN0JywgdGhpcy5hZ2VudFBhdGgsXG4gICAgICAnLXNjaGVtZScsICdXZWJEcml2ZXJBZ2VudFJ1bm5lcicsXG4gICAgICAnLWRlc3RpbmF0aW9uJywgYGlkPSR7dGhpcy5kZXZpY2UudWRpZH1gLFxuICAgICAgJy1jb25maWd1cmF0aW9uJywgJ0RlYnVnJyxcbiAgICBdO1xuXG4gICAgaWYgKHRoaXMucmVhbERldmljZSkge1xuICAgICAgY21kID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ2JpbicsICdydW4teGNvZGVidWlsZC5zaCcpO1xuICAgICAgYXJncyA9IFtcbiAgICAgICAgJy0tcHJvamVjdCcsIHRoaXMuYWdlbnRQYXRoLFxuICAgICAgICAnLS1zY2hlbWUnLCAnV2ViRHJpdmVyQWdlbnRSdW5uZXInLFxuICAgICAgICAnLS1kZXN0aW5hdGlvbicsIGBpZD0ke3RoaXMuZGV2aWNlLnVkaWR9YCxcbiAgICAgIF07XG4gICAgICBpZiAodGhpcy54Y29kZUNvbmZpZ0ZpbGUpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBVc2luZyBYY29kZSBjb25maWd1cmF0aW9uIGZpbGU6ICcke3RoaXMueGNvZGVDb25maWdGaWxlfSdgKTtcbiAgICAgICAgYXJncy5wdXNoKCctLXhjb2RlLWNvbmZpZy1maWxlJywgYFwiJHt0aGlzLnhjb2RlQ29uZmlnRmlsZX1cImApO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMua2V5Y2hhaW5QYXRoICYmIHRoaXMua2V5Y2hhaW5QYXNzd29yZCkge1xuICAgICAgICBhcmdzLnB1c2goJy0ta2V5Y2hhaW4tcGF0aCcsIHRoaXMua2V5Y2hhaW5QYXRoKTtcbiAgICAgICAgYXJncy5wdXNoKCctLWtleWNoYWluLXBhc3N3b3JkJywgdGhpcy5rZXljaGFpblBhc3N3b3JkKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYEJlZ2lubmluZyB0ZXN0IHdpdGggY29tbWFuZCAnJHtjbWR9ICR7YXJncy5qb2luKCcgJyl9JyBgICtcbiAgICAgICAgICAgICAgYGluIGRpcmVjdG9yeSAnJHt0aGlzLmJvb3RzdHJhcFBhdGh9J2ApO1xuICAgIGxldCB4Y29kZWJ1aWxkID0gbmV3IFN1YlByb2Nlc3MoY21kLCBhcmdzLCB7Y3dkOiB0aGlzLmJvb3RzdHJhcFBhdGh9KTtcblxuICAgIGxldCBsb2dYY29kZU91dHB1dCA9IHRoaXMuc2hvd1hjb2RlTG9nO1xuICAgIHhjb2RlYnVpbGQub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgbGV0IG91dCA9IHN0ZG91dCB8fCBzdGRlcnI7XG4gICAgICAvLyB3ZSB3YW50IHRvIHB1bGwgb3V0IHRoZSBsb2cgZmlsZSB0aGF0IGlzIGNyZWF0ZWQsIGFuZCBoaWdobGlnaHQgaXRcbiAgICAgIC8vIGZvciBkaWFnbm9zdGljIHB1cnBvc2VzXG4gICAgICBpZiAob3V0LmluZGV4T2YoJ1dyaXRpbmcgZGlhZ25vc3RpYyBsb2cgZm9yIHRlc3Qgc2Vzc2lvbiB0bycpICE9PSAtMSkge1xuICAgICAgICAvLyBwdWxsIG91dCB0aGUgZmlyc3QgbGluZSB0aGF0IGJlZ2lucyB3aXRoIHRoZSBwYXRoIHNlcGFyYXRvclxuICAgICAgICAvLyB3aGljaCAqc2hvdWxkKiBiZSB0aGUgbGluZSBpbmRpY2F0aW5nIHRoZSBsb2cgZmlsZSBnZW5lcmF0ZWRcbiAgICAgICAgbGV0IGxvZ0xvY2F0aW9uID0gXy5maXJzdChfLnJlbW92ZShvdXQudHJpbSgpLnNwbGl0KCdcXG4nKSwgKHYpID0+IHYuaW5kZXhPZihwYXRoLnNlcCkgPT09IDApKTtcbiAgICAgICAgbG9nLmRlYnVnKGBMb2cgZmlsZSBmb3IgeGNvZGVidWlsZCB0ZXN0OiAke2xvZ0xvY2F0aW9ufWApO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiB3ZSBoYXZlIGFuIGVycm9yIHdlIHdhbnQgdG8gb3V0cHV0IHRoZSBsb2dzXG4gICAgICAvLyBvdGhlcndpc2UgdGhlIGZhaWx1cmUgaXMgaW5zY3J1dGlibGVcbiAgICAgIGlmIChvdXQuaW5kZXhPZignRXJyb3IgRG9tYWluPScpICE9PSAtMSkge1xuICAgICAgICBsb2dYY29kZU91dHB1dCA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChsb2dYY29kZU91dHB1dCkge1xuICAgICAgICB4Y29kZUxvZy5pbmZvKG91dCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4geGNvZGVidWlsZDtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVNpbUxvZ3NTdWJQcm9jZXNzICgpIHtcbiAgICBsZXQgYXJncyA9IFtcbiAgICAgICctZicsXG4gICAgICAnLW4nLCAnMCcsXG4gICAgICBwYXRoLnJlc29sdmUodGhpcy5kZXZpY2UuZ2V0TG9nRGlyKCksICdzeXN0ZW0ubG9nJylcbiAgICBdO1xuXG4gICAgbGV0IGxvZ3MgPSBuZXcgU3ViUHJvY2VzcygndGFpbCcsIGFyZ3MpO1xuICAgIHRoaXMuc2V0dXBMb2dnaW5nKGxvZ3MsICdTaW0nKTtcbiAgICByZXR1cm4gbG9ncztcbiAgfVxuXG4gIGNyZWF0ZWlQcm94eVN1YlByb2Nlc3MgKGxvY2FscG9ydCwgZGV2aWNlcG9ydCkge1xuICAgIGxvZy5kZWJ1ZyhgU3RhcnRpbmcgaXByb3h5IHRvIGZvcndhcmQgdHJhZmZpYyBmcm9tIGxvY2FsIHBvcnQgJHtsb2NhbHBvcnR9IHRvIGRldmljZSBwb3J0ICR7ZGV2aWNlcG9ydH0gb3ZlciBVU0JgKTtcbiAgICByZXR1cm4gbmV3IFN1YlByb2Nlc3MoYGlwcm94eWAsIFtsb2NhbHBvcnQsIGRldmljZXBvcnQsIHRoaXMuZGV2aWNlLnVkaWRdKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZVJlYWxEZXZpY2VMb2dzU3ViUHJvY2VzcyAoKSB7XG4gICAgYXN5bmMgZnVuY3Rpb24gY2hlY2tGb3JMb2dnZXIgKGxvZ2dlcikge1xuICAgICAgLy8gdGhlIGxvZ2dlciBjYW4gYmUgdGhlIG5hbWUgb2YgYSBwcm9ncmFtIG9uIHRoZSBQQVRIXG4gICAgICAvLyBvciBhIHBhdGggdG8gdGhlIHByb2dyYW1cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGZzLndoaWNoKGxvZ2dlcik7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLy8gbm90IG9uIHRoZSBQQVRILCBzbyBzZWUgaWYgaXQgaXMgYW4gYWNjZXNzaWJsZSBwYXRoIGl0c2VsZlxuICAgICAgICByZXR1cm4gYXdhaXQgZnMuZXhpc3RzKGxvZ2dlcik7XG4gICAgICB9XG5cbiAgICAgIC8vIG5vIGVycm9yIHRocm93biwgc28gYWxsIGlzIHdlbGxcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGNoZWNrRm9yTG9nZ2VyKHRoaXMucmVhbERldmljZUxvZ2dlcikpIHtcbiAgICAgIC8vIHdlIGhhdmUgbm8gbG9nZ2VyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBmaW5kIHJlYWwgZGV2aWNlIGxvZ2dpbmcgcHJvZ3JhbSAnJHt0aGlzLnJlYWxEZXZpY2VMb2dnZXJ9J2ApO1xuICAgIH1cblxuICAgIGxldCBsb2dzID0gbmV3IFN1YlByb2Nlc3MoYCR7dGhpcy5yZWFsRGV2aWNlTG9nZ2VyfWAsIFsnLXUnLCB0aGlzLmRldmljZS51ZGlkXSk7XG4gICAgdGhpcy5zZXR1cExvZ2dpbmcobG9ncywgJ0RldmljZScpO1xuICAgIHJldHVybiBsb2dzO1xuICB9XG5cbiAgc2V0dXBMb2dnaW5nIChsb2dzLCBwcmVmaXgpIHtcbiAgICBsZXQgbG9nZ2luZ1N0YXJ0ZWQgPSAhdGhpcy5yZWFsRGV2aWNlO1xuICAgIGxldCBzdGFydFRpbWUgPSBuZXcgRGF0ZSgpO1xuICAgIGZ1bmN0aW9uIHNob3VsZFN0YXJ0TG9nZ2luZyAocm93KSB7XG4gICAgICBsZXQgbG9nUm93UGFydHMgPSByb3cuc3BsaXQoL1xccysvKTtcbiAgICAgIGxldCBsb2dSb3dEYXRlID0gbmV3IERhdGUoYCR7c3RhcnRUaW1lLmdldEZ1bGxZZWFyKCl9ICR7bG9nUm93UGFydHNbMF19ICR7bG9nUm93UGFydHNbMV19ICR7bG9nUm93UGFydHNbMl19YCk7XG4gICAgICBsb2dnaW5nU3RhcnRlZCA9IGxvZ1Jvd0RhdGUuaXNBZnRlcihzdGFydFRpbWUpO1xuICAgICAgcmV0dXJuIGxvZ2dpbmdTdGFydGVkO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGlzUGVydGluZW50TG9nTGluZSAobGluZSkge1xuICAgICAgcmV0dXJuIGxpbmUubGVuZ3RoICYmXG4gICAgICAgICAgICAobGluZS5pbmRleE9mKEFHRU5UX0xPR19QUkVGSVgpICE9PSAtMSB8fFxuICAgICAgICAgICAgIGxpbmUuaW5kZXhPZihBR0VOVF9SVU5ORVJfTE9HX1BSRUZJWCkgIT09IC0xIHx8XG4gICAgICAgICAgICAgbGluZS5pbmRleE9mKFNJTV9CUklER0VfTE9HX1BSRUZJWCkgIT09IC0xKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZWFsRGV2aWNlICYmIHRoaXMucmVhbERldmljZUxvZ2dlci5pbmRleE9mKCdpZGV2aWNlc3lzbG9nJykgIT09IC0xKSB7XG4gICAgICAvLyB3ZSBhcmUgdXNpbmcgaWRldmljZXN5c2xvZywgd2hpY2ggc29tZXRpbWVzIGNhbm5vdCBjb25uZWN0IHRvIHRoZSBkZXZpY2VcbiAgICAgIC8vIGF0IHdoaWNoIHRpbWUgdGhlIHN5c3RlbSB3aWxsIG5vdCBiZSBhYmxlIHRvIGZpZ3VyZSBvdXQgdGhhdCB0aGUgcHJvY2Vzc1xuICAgICAgLy8gaGFzIHN0YXJ0ZWRcbiAgICAgIGxvZ3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICBsZXQgZXJyb3JTdHJpbmcgPSAnQ291bGQgbm90IHN0YXJ0IGxvZ2dlciBmb3IgdWRpZCc7XG4gICAgICAgIGlmIChzdGRvdXQuaW5kZXhPZihlcnJvclN0cmluZykgIT09IC0xIHx8IHN0ZGVyci5pbmRleE9mKGVycm9yU3RyaW5nKSAhPT0gLTEpIHtcbiAgICAgICAgICAvLyB1bmZvcnR1bmF0ZWx5IHdlIGhhdmUgbm8gd2F5IHRvIHN0b3BwaW5nIHRoZSBwcm9jZXNzLCBzbyBqdXN0IGxvZyBvdmVydGx5XG4gICAgICAgICAgbGV0IG1zZyA9IGBUaGUgcmVhbCBkZXZpY2UgbG9nZ2VyICcke3RoaXMucmVhbERldmljZUxvZ2dlcn0nIHdhcyBgICtcbiAgICAgICAgICAgICAgICAgICAgYHVuYWJsZSB0byBzdGFydCBsb2cgY2FwdHVyZS4gUGxlYXNlIHRyeSBpbnN0YWxsaW5nIGAgK1xuICAgICAgICAgICAgICAgICAgICBgJ2RldmljZWNvbnNvbGUnICgnbnBtIGluc3RhbGwgLWcgZGV2aWNlY29uc29sZScpIGFuZCBgICtcbiAgICAgICAgICAgICAgICAgICAgYHNwZWNpZnkgdGhlIHBhdGggdG8gaXQgdXNpbmcgdGhlICdyZWFsRGV2aWNlTG9nZ2VyJyBjYXBhYmlsaXR5LmA7XG4gICAgICAgICAgbG9nLmVycm9yKG1zZyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pb3NMb2dBbHJlYWR5U2hvd24pIHtcbiAgICAgIGxvZ3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgICBsZXQgb3V0ID0gc3Rkb3V0IHx8IHN0ZGVycjtcbiAgICAgICAgLy8gbWFrZSBzdXJlIHdlIGFyZSBub3QgcmVhZGluZyBsb2dzIGZyb20gYmVmb3JlIHRoaXMgdGVzdCBydW5cbiAgICAgICAgaWYgKCFsb2dnaW5nU3RhcnRlZCAmJiAhc2hvdWxkU3RhcnRMb2dnaW5nKG91dCkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlzUGVydGluZW50TG9nTGluZShvdXQpKSB7XG4gICAgICAgICAgZm9yIChsZXQgbGluZSBvZiBvdXQuc3BsaXQoXCJcXG5cIikuZmlsdGVyKEJvb2xlYW4pKSB7XG4gICAgICAgICAgICBhZ2VudExvZy5kZWJ1ZyhgJHtwcmVmaXh9OiAke2xpbmV9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzdGFydFhjb2RlYnVpbGQgKCkge1xuICAgIC8vIHdyYXAgdGhlIHN0YXJ0IHByb2NlZHVyZSBpbiBhIHByb21pc2Ugc28gdGhhdCB3ZSBjYW4gY2F0Y2gsIGFuZCByZXBvcnQsXG4gICAgLy8gYW55IHN0YXJ0dXAgZXJyb3JzIHRoYXQgYXJlIHRocm93biBhcyBldmVudHNcbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy54Y29kZWJ1aWxkLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgICBsb2cuaW5mbyhgeGNvZGVidWlsZCBleGl0ZWQgd2l0aCBjb2RlICcke2NvZGV9JyBhbmQgc2lnbmFsICcke3NpZ25hbH0nYCk7XG4gICAgICAgIGlmICghc2lnbmFsICYmIGNvZGUgIT09IDApIHtcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcihgeGNvZGVidWlsZCBmYWlsZWQgd2l0aCBjb2RlICR7Y29kZX1gKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmRldmljZUxvZ3Mub24oJ2V4aXQnLCAoY29kZSkgPT4ge1xuICAgICAgICBsZXQgbXNnID0gYCR7dGhpcy5yZWFsRGV2aWNlID8gJ1N5c3RlbScgOiAnU2ltdWxhdG9yJ30gbG9nIGV4aXRlZCB3aXRoIGNvZGUgJyR7Y29kZX0nYDtcbiAgICAgICAgbG9nLmluZm8obXNnKTtcbiAgICAgICAgaWYgKGNvZGUpIHtcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KG1zZyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgICB0cnkge1xuICAgICAgICBsZXQgc3RhcnRUaW1lID0gbmV3IERhdGUoKTtcbiAgICAgICAgYXdhaXQgdGhpcy54Y29kZWJ1aWxkLnN0YXJ0KCk7XG4gICAgICAgIGxldCBhZ2VudFVybCA9IGF3YWl0IHRoaXMud2FpdEZvclN0YXJ0KHN0YXJ0VGltZSk7XG4gICAgICAgIHJlc29sdmUoYWdlbnRVcmwpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxldCBtc2cgPSBgVW5hYmxlIHRvIHN0YXJ0IFdlYkRyaXZlckFnZW50OiAke2Vycn1gO1xuICAgICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgICAgcmV0dXJuIHJlamVjdChtc2cpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgd2FpdEZvclN0YXJ0IChzdGFydFRpbWUpIHtcbiAgICAvLyB3ZSBoYXZlIHRvIHdhaXQgZm9yIHRoZSBzaW0gdG8gc3RhcnQgYmVmb3JlIHdlIGNhbiB0YWlsIHRoZSBsb2cgZmlsZVxuICAgIGlmICghdGhpcy5yZWFsRGV2aWNlKSB7XG4gICAgICBhd2FpdCBzeXN0ZW1Mb2dFeGlzdHModGhpcy5kZXZpY2UpO1xuICAgIH1cblxuICAgIGxldCBhZ2VudFVybDtcbiAgICBsZXQgbGluZUNvdW50ID0gMDtcbiAgICBsZXQgcmVhY2hlZEVuZCA9ICF0aGlzLnJlYWxEZXZpY2U7IC8vIHNpbXVsYXRvciBkb2VzIG5vdCBuZWVkIHRvIHdhaXQsIHNpbmNlIHdlIGFyZSB0YWlsaW5nXG5cbiAgICBsZXQgc3RhcnREZXRlY3RvciA9IChzdGRvdXQpID0+IHtcbiAgICAgIC8vIG9uIGEgcmVhbCBkZXZpY2UgdGhlcmUgbWF5IGFscmVhZHkgYmUgc3lzdGVtIGxvZ3MgdGhhdCBuZWVkIHRvIGJlXG4gICAgICAvLyBwYXNzZWQgYmVmb3JlIHdlIGdldCB0byB0aGUgcmVhbCBzdGFydHVwIGxvZ3MsIG90aGVyd2lzZVxuICAgICAgLy8gd2UgZXhwZWN0IHR3byBsaW5lcywgb25lIGFmdGVyIGFub3RoZXJcbiAgICAgIC8vICAgICBKdWwgMjAgMTM6MDM6NTcgaWFtUGhvbmUgWENUUnVubmVyWzI5Nl0gPFdhcm5pbmc+OiBCdWlsdCBhdCBKdWwgMjAgMjAxNiAxMzowMzo1MFxuICAgICAgLy8gICAgIEp1bCAyMCAxMzowMzo1NyBpYW1QaG9uZSBYQ1RSdW5uZXJbMjk2XSA8V2FybmluZz46IFNlcnZlclVSTEhlcmUtPmh0dHA6Ly8xMC4zNS40LjEyMjo4MTAwPC1TZXJ2ZXJVUkxIZXJlXG4gICAgICBpZiAoIXJlYWNoZWRFbmQpIHtcbiAgICAgICAgbGV0IGRhdGVNYXRjaCA9IExPR19TVEFSVFRJTUVfUkVHRVguZXhlYyhzdGRvdXQpO1xuICAgICAgICBpZiAoZGF0ZU1hdGNoKSB7XG4gICAgICAgICAgbGV0IGJ1aWxkVGltZSA9IG5ldyBEYXRlKGRhdGVNYXRjaFsxXSk7XG4gICAgICAgICAgaWYgKGJ1aWxkVGltZS5pc0FmdGVyKHN0YXJ0VGltZSkpIHtcbiAgICAgICAgICAgIHJlYWNoZWRFbmQgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAocmVhY2hlZEVuZCkge1xuICAgICAgICBsZXQgbWF0Y2ggPSBBR0VOVF9TVEFSVEVEX1JFR0VYLmV4ZWMoc3Rkb3V0KTtcbiAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgYWdlbnRVcmwgPSBtYXRjaFsxXTtcbiAgICAgICAgICBsb2cuaW5mbyhgRGV0ZWN0ZWQgdGhhdCBXZWJEcml2ZXJBZ2VudCBpcyBydW5uaW5nIGF0IHVybCAnJHthZ2VudFVybH0nYCk7XG4gICAgICAgICAgaWYgKCFhZ2VudFVybCkge1xuICAgICAgICAgICAgbG9nLmVycm9yQW5kVGhyb3cobmV3IEVycm9yKCdObyB1cmwgZGV0ZWN0ZWQgZnJvbSBXZWJEcml2ZXJBZ2VudCcpKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gcGVyaW9kaWNhbGx5IGxvZywgc28gaXQgZG9lcyBub3QgbG9vayBsaWtlIGV2ZXJ5dGhpbmcgZGllZFxuICAgICAgbGluZUNvdW50Kys7XG4gICAgICBsZXQgdGhyZXNob2xkID0gdGhpcy5yZWFsRGV2aWNlID8gMTAwMCA6IDIwMDtcbiAgICAgIGlmIChsaW5lQ291bnQgJSB0aHJlc2hvbGQgPT09IDApIHtcbiAgICAgICAgbG9nLmRlYnVnKCdXYWl0aW5nIGZvciBXZWJEcml2ZXJBZ2VudCBzZXJ2ZXIgdG8gZmluaXNoIGxvYWRpbmcuLi4nKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH07XG5cbiAgICBsb2cuaW5mbygnV2FpdGluZyBmb3IgV2ViRHJpdmVyQWdlbnQgdG8gc3RhcnQgb24gZGV2aWNlJyk7XG4gICAgYXdhaXQgdGhpcy5kZXZpY2VMb2dzLnN0YXJ0KHN0YXJ0RGV0ZWN0b3IpO1xuICAgIGxvZy5pbmZvKGBXZWJEcml2ZXJBZ2VudCBzdGFydGVkIGF0IHVybCAnJHthZ2VudFVybH0nYCk7XG5cbiAgICByZXR1cm4gYWdlbnRVcmw7XG4gIH1cblxuICBhc3luYyBzdGFydGlwcm94eSAoKSB7XG4gICAgcmV0dXJuIGF3YWl0IG5ldyBCKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuaXByb3h5Lm9uKCdleGl0JywgKGNvZGUpID0+IHtcbiAgICAgICAgaWYgKGNvZGUpIHtcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcihgaXByb3h5IGV4aXRlZCB3aXRoIGNvZGUgJyR7Y29kZX0nYCkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMuaXByb3h5Lm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgICAgbGV0IG91dCA9IHN0ZG91dCB8fCBzdGRlcnI7XG4gICAgICAgIGZvciAobGV0IGxpbmUgb2Ygb3V0LnNwbGl0KCdcXG4nKSkge1xuICAgICAgICAgIGlmICghbGluZS5sZW5ndGgpIGNvbnRpbnVlO1xuICAgICAgICAgIGlwcm94eUxvZy5kZWJ1ZyhsaW5lKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IHRoaXMuaXByb3h5LnN0YXJ0KDIwMDApO1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgcXVpdCAoKSB7XG4gICAgbG9nLmluZm8oJ1NodXR0aW5nIGRvd24gV2ViRHJpdmVyQWdlbnQnKTtcbiAgICBsZXQgZ2V0U3RvcFByb21pc2VzID0gKHNpZ25hbCkgPT4ge1xuICAgICAgbGV0IHN0b3BzID0gW107XG4gICAgICBpZiAodGhpcy54Y29kZWJ1aWxkICYmIHRoaXMueGNvZGVidWlsZC5wcm9jKSB7XG4gICAgICAgIHN0b3BzLnB1c2godGhpcy54Y29kZWJ1aWxkLnN0b3Aoc2lnbmFsKSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5kZXZpY2VMb2dzICYmIHRoaXMuZGV2aWNlTG9ncy5wcm9jKSB7XG4gICAgICAgIHN0b3BzLnB1c2godGhpcy5kZXZpY2VMb2dzLnN0b3Aoc2lnbmFsKSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5pcHJveHkgJiYgdGhpcy5pcHJveHkucHJvYykge1xuICAgICAgICBzdG9wcy5wdXNoKHRoaXMuaXByb3h5LnN0b3Aoc2lnbmFsKSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gc3RvcHM7XG4gICAgfTtcblxuICAgIGlmICh0aGlzLmp3cHJveHkpIHtcbiAgICAgIHRoaXMuandwcm94eS5zZXNzaW9uSWQgPSBudWxsO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBCLmFsbChnZXRTdG9wUHJvbWlzZXMoKSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZignUHJvY2VzcyBkaWRuXFwndCBlbmQgYWZ0ZXInKSA9PT0gLTEpIHtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKCdXZWJEcml2ZXJBZ2VudCBwcm9jZXNzIGRpZCBub3QgZW5kIGluIGEgdGltZWx5IGZhc2hpb24uICcgK1xuICAgICAgICAgICAgICAgICdTZW5kaW5nIFNJR0hVUCBzaWduYWwuLi4nKTtcbiAgICAgIGF3YWl0IEIuYWxsKGdldFN0b3BQcm9taXNlcygnU0lHSFVQJykpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBXZWJEcml2ZXJBZ2VudDtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
