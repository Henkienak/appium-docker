From 8b315d76b2d3dcfb2bd457272adae37e18eb5e33 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andreas=20L=C3=BCdeke?= <aluedeke@testobject.com>
Date: Mon, 29 Feb 2016 13:00:31 +0100
Subject: [PATCH 1/1] fix BufferOverflow by limiting output of dumpsys

---
 node_modules/appium-adb/lib/adb.js | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/lib/adb.js b/lib/adb.js
index 5604125..3c25338 100644
--- a/node_modules/appium-adb/lib/adb.js
+++ b/node_modules/appium-adb/lib/adb.js
@@ -1237,7 +1237,7 @@ ADB.prototype.androidCoverage = function (instrumentClass, waitPkg, waitActivity

 ADB.prototype.getFocusedPackageAndActivity = function (cb) {
   logger.debug("Getting focused package and activity");
-  var cmd = "dumpsys window windows"
+  var cmd = "dumpsys window windows | grep -e FocusedApp"
     , nullRe = new RegExp(/mFocusedApp=null/)
     , searchRe = new RegExp(
       /mFocusedApp.+Record\{.*\s([^\s\/\}]+)\/([^\s\/\}]+)(\s[^\s\/\}]+)*\}/);
@@ -1466,7 +1466,7 @@ ADB.prototype.keyevent = function (keycode, cb) {
 };

 ADB.prototype.isScreenLocked = function (cb) {
-  var cmd = "dumpsys window";
+  var cmd = "dumpsys window | grep -e ShowingLockscreen -e CurrentFocus -e ScreenOnFully";
   this.shell(cmd, function (err, stdout) {
     if (err) return cb(err);
     if (process.env.APPIUM_LOG_DUMPSYS) {
--
2.6.0
